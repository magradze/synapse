# РЈ▒№ИЈ рЃЏрЃЮрЃЊрЃБрЃџрЃў: `time_sync`

**­ЪЌѓ№ИЈ рЃЎрЃљрЃбрЃћрЃњрЃЮрЃарЃўрЃљ:** `system`
**Рюњ№ИЈ рЃљрЃЋрЃбрЃЮрЃарЃў:** Synapse Framework Team
**­Ъћќ рЃЋрЃћрЃарЃАрЃўрЃљ:** 2.0.0

## 1. ­ЪЊю рЃЏрЃўрЃЏрЃЮрЃ«рЃўрЃџрЃЋрЃљ

`time_sync` рЃљрЃарЃўрЃА Synapse Framework-рЃўрЃА **рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃарЃў рЃЊрЃарЃЮрЃўрЃА рЃАрЃўрЃюрЃЦрЃарЃЮрЃюрЃўрЃќрЃљрЃфрЃўрЃўрЃА** рЃцрЃБрЃюрЃЊрЃљрЃЏрЃћрЃюрЃбрЃБрЃарЃў рЃЏрЃЮрЃЊрЃБрЃџрЃў. рЃЏрЃўрЃАрЃў рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃљрЃЏрЃЮрЃфрЃљрЃюрЃљрЃљ, рЃБрЃќрЃарЃБрЃюрЃЋрЃћрЃџрЃДрЃЮрЃА рЃЏрЃЮрЃгрЃДрЃЮрЃЉрЃўрЃџрЃЮрЃЉрЃўрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃарЃў рЃАрЃљрЃљрЃЌрЃўрЃА рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃў рЃњрЃљрЃАрЃгрЃЮрЃарЃћрЃЉрЃљ рЃўрЃюрЃбрЃћрЃарЃюрЃћрЃбрЃерЃў рЃљрЃарЃАрЃћрЃЉрЃБрЃџ рЃЊрЃарЃЮрЃўрЃА рЃАрЃћрЃарЃЋрЃћрЃарЃћрЃЉрЃЌрЃљрЃю **SNTP (Simple Network Time Protocol)** рЃърЃарЃЮрЃбрЃЮрЃЎрЃЮрЃџрЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃЌ.

рЃћрЃА рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃњрЃљрЃЏрЃЮрЃарЃўрЃфрЃ«рЃљрЃЋрЃА рЃњрЃљрЃарЃћ RTC (Real-Time Clock) рЃљрЃърЃљрЃарЃљрЃбрЃБрЃарЃўрЃА рЃАрЃљрЃГрЃўрЃарЃЮрЃћрЃЉрЃљрЃА рЃЊрЃљ рЃўрЃДрЃћрЃюрЃћрЃЉрЃА рЃљрЃарЃАрЃћрЃЉрЃБрЃџ WiFi рЃЎрЃљрЃЋрЃерЃўрЃарЃА, рЃарЃљрЃЌрЃљ рЃЏрЃЮрЃгрЃДрЃЮрЃЉрЃўрЃџрЃЮрЃЉрЃўрЃА рЃЊрЃарЃЮ рЃДрЃЮрЃЋрЃћрЃџрЃЌрЃЋрЃўрЃА рЃўрЃДрЃЮрЃА рЃќрЃБрЃАрЃбрЃў. рЃћрЃА рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџрЃљрЃЊ рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃўрЃљ рЃўрЃАрЃћрЃЌрЃў рЃцрЃБрЃюрЃЦрЃфрЃўрЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА, рЃарЃЮрЃњрЃЮрЃарЃўрЃфрЃљрЃљ рЃџрЃЮрЃњрЃћрЃЉрЃўрЃА рЃЊрЃарЃЮрЃўрЃА рЃюрЃўрЃерЃюрЃБрЃџрЃћрЃЉрЃў (timestamps), рЃЊрЃљрЃњрЃћрЃњрЃЏрЃўрЃџрЃў рЃљрЃЏрЃЮрЃфрЃљрЃюрЃћрЃЉрЃў рЃЊрЃљ, рЃарЃљ рЃЌрЃЦрЃЏрЃљ рЃБрЃюрЃЊрЃљ, рЃЊрЃарЃЮрЃўрЃА рЃЕрЃЋрЃћрЃюрЃћрЃЉрЃљ рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃџрЃўрЃА рЃўрЃюрЃбрЃћрЃарЃцрЃћрЃўрЃАрЃќрЃћ.

## 2. ­ЪЈЏ№ИЈ рЃљрЃарЃЦрЃўрЃбрЃћрЃЦрЃбрЃБрЃарЃБрЃџрЃў рЃърЃарЃўрЃюрЃфрЃўрЃърЃћрЃЉрЃў

- **Service Provider:** ­ЪЋ░№ИЈ рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃарЃўрЃА рЃАрЃБрЃцрЃЌрЃљ "рЃАрЃћрЃарЃЋрЃўрЃАрЃўрЃА рЃЏрЃЮрЃЏрЃгрЃЮрЃЊрЃћрЃЉрЃћрЃџрЃў". рЃўрЃА рЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃА `time_sync_api_t` рЃАрЃћрЃарЃЋрЃўрЃАрЃА `Service Locator`-рЃерЃў, `FMW_SERVICE_TYPE_TIME_SYNC_API` рЃбрЃўрЃърЃўрЃЌ, рЃарЃљрЃЌрЃљ рЃАрЃ«рЃЋрЃљ рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃЏрЃљ (рЃЏрЃљрЃњ., `ui_manager`) рЃерЃћрЃФрЃџрЃЮрЃю рЃќрЃБрЃАрЃбрЃў рЃЊрЃарЃЮрЃўрЃА рЃЏрЃўрЃдрЃћрЃЉрЃљ.
- **Event Consumer:** ­Ъїљ рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃарЃўрЃА "рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃўрЃА рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃћрЃџрЃў". рЃўрЃА рЃњрЃљрЃЏрЃЮрЃўрЃгрЃћрЃарЃА `WIFI_EVENT_IP_ASSIGNED` рЃўрЃЋрЃћрЃюрЃЌрЃА. рЃАрЃўрЃюрЃЦрЃарЃЮрЃюрЃўрЃќрЃљрЃфрЃўрЃўрЃА рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃўрЃгрЃДрЃћрЃЉрЃљ рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃЏрЃљрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ, рЃарЃљрЃф WiFi рЃЎрЃљрЃЋрЃерЃўрЃарЃў рЃЊрЃљрЃЏрЃДрЃљрЃарЃЊрЃћрЃЉрЃљ рЃЊрЃљ рЃЏрЃЮрЃгрЃДрЃЮрЃЉрЃўрЃџрЃЮрЃЉрЃљ рЃЏрЃўрЃўрЃдрЃћрЃЉрЃА IP рЃЏрЃўрЃАрЃљрЃЏрЃљрЃарЃЌрЃА.
- **рЃљрЃАрЃўрЃюрЃЦрЃарЃЮрЃюрЃБрЃџрЃў рЃЮрЃърЃћрЃарЃљрЃфрЃўрЃљ:** ­Ъћё рЃЊрЃарЃЮрЃўрЃА рЃАрЃўрЃюрЃЦрЃарЃЮрЃюрЃўрЃќрЃљрЃфрЃўрЃљ рЃ«рЃЊрЃћрЃЉрЃљ рЃљрЃАрЃўрЃюрЃЦрЃарЃЮрЃюрЃБрЃџрЃљрЃЊ, ESP-IDF-рЃўрЃА `esp_sntp` рЃЎрЃЮрЃЏрЃърЃЮрЃюрЃћрЃюрЃбрЃўрЃА рЃЏрЃћрЃерЃЋрЃћрЃЮрЃЉрЃўрЃЌ. рЃърЃарЃЮрЃфрЃћрЃАрЃўрЃА рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃўрЃАрЃљрЃА, рЃАрЃърЃћрЃфрЃўрЃљрЃџрЃБрЃарЃў `callback` рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ рЃљрЃцрЃўрЃЦрЃАрЃўрЃарЃћрЃЉрЃА рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃљрЃА рЃЊрЃљ рЃљрЃДрЃћрЃюрЃћрЃЉрЃА рЃерЃўрЃЊрЃљ `is_synced` рЃцрЃџрЃљрЃњрЃА.
- **рЃЊрЃарЃЮрЃўрЃА рЃќрЃЮрЃюрЃўрЃА рЃЏрЃ«рЃљрЃарЃЊрЃљрЃГрЃћрЃарЃљ:** РЈ░ рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃЎрЃўрЃЌрЃ«рЃБрЃџрЃЮрЃЉрЃА `timezone` рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃА рЃЌрЃљрЃЋрЃўрЃАрЃў `config.json` рЃцрЃљрЃўрЃџрЃўрЃЊрЃљрЃю рЃЊрЃљ рЃљрЃДрЃћрЃюрЃћрЃЉрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃа `TZ` рЃњрЃљрЃарЃћрЃЏрЃЮрЃА рЃфрЃЋрЃџрЃљрЃЊрЃА. рЃћрЃА рЃБрЃќрЃарЃБрЃюрЃЋрЃћрЃџрЃДрЃЮрЃцрЃА, рЃарЃЮрЃЏ C-рЃА рЃАрЃбрЃљрЃюрЃЊрЃљрЃарЃбрЃБрЃџрЃў рЃЊрЃарЃЮрЃўрЃА рЃцрЃБрЃюрЃЦрЃфрЃўрЃћрЃЉрЃў (`localtime_r`) рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃњрЃљрЃарЃЊрЃљрЃЦрЃЏрЃюрЃўрЃА UTC рЃЊрЃарЃЮрЃА рЃАрЃгрЃЮрЃа рЃџрЃЮрЃЎрЃљрЃџрЃБрЃа рЃЊрЃарЃЮрЃерЃў.

## 3. РџЎ№ИЈ рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ

рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ рЃ«рЃЊрЃћрЃЉрЃљ рЃЏрЃўрЃАрЃў `config.json` рЃцрЃљрЃўрЃџрЃўрЃА рЃАрЃљрЃерЃБрЃљрЃџрЃћрЃЉрЃўрЃЌ.

| рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃў | рЃбрЃўрЃърЃў | рЃљрЃдрЃгрЃћрЃарЃљ | рЃАрЃљрЃЋрЃљрЃџрЃЊрЃћрЃЉрЃБрЃџрЃЮ |
| :--- | :--- | :--- | :---: |
| `instance_name` | рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў | рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃљрЃЏ рЃўрЃюрЃАрЃбрЃљрЃюрЃфрЃўрЃўрЃА рЃБрЃюрЃўрЃЎрЃљрЃџрЃБрЃарЃў рЃАрЃљрЃ«рЃћрЃџрЃў. | РюЁ |
| `timezone` | рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў | рЃЊрЃарЃЮрЃўрЃА рЃќрЃЮрЃюрЃўрЃА рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў POSIX рЃцрЃЮрЃарЃЏрЃљрЃбрЃерЃў. | РЮї (Default: UTC) |

**рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў (рЃАрЃљрЃцрЃарЃљрЃюрЃњрЃћрЃЌрЃўрЃАрЃЌрЃЋрЃўрЃА):**

```json
[
  {
    "type": "time_sync",
    "enabled": true,
    "config": {
      "instance_name": "main_time_sync",
      "timezone": "CET-1CEST,M3.5.0,M10.5.0/3"
    }
  }
]
```

**рЃАрЃљрЃЦрЃљрЃарЃЌрЃЋрЃћрЃџрЃЮрЃАрЃЌрЃЋрЃўрЃА (`UTC+4`) рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћрЃЌ:** `"timezone": "<-04>4"`

## 4. ­Ъћї Service API (`time_sync_api_t`)

рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃгрЃЋрЃЊрЃўрЃА рЃћрЃарЃЌ, рЃЏрЃљрЃарЃбрЃўрЃЋ API рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃА.

- **`esp_err_t get_time(time_t *current_time);`**
  - **рЃљрЃдрЃгрЃћрЃарЃљ:** рЃљрЃЉрЃарЃБрЃюрЃћрЃЉрЃА рЃЏрЃўрЃЏрЃЊрЃўрЃюрЃљрЃарЃћ, рЃАрЃўрЃюрЃЦрЃарЃЮрЃюрЃўрЃќрЃћрЃЉрЃБрЃџ рЃЊрЃарЃЮрЃА.
  - **рЃљрЃЉрЃарЃБрЃюрЃћрЃЉрЃА:**
    - `ESP_OK`: рЃЌрЃБ рЃЊрЃарЃЮ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃўрЃЦрЃюрЃљ рЃЏрЃўрЃдрЃћрЃЉрЃБрЃџрЃў.
    - `ESP_ERR_INVALID_STATE`: рЃЌрЃБ рЃЊрЃарЃЮ рЃ»рЃћрЃа рЃљрЃа рЃљрЃарЃўрЃА рЃАрЃўрЃюрЃЦрЃарЃЮрЃюрЃўрЃќрЃћрЃЉрЃБрЃџрЃў.

## 5. ­ЪњА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў

`ui_manager` рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃўрЃДрЃћрЃюрЃћрЃЉрЃА рЃљрЃЏ рЃАрЃћрЃарЃЋрЃўрЃАрЃА рЃАрЃљрЃљрЃЌрЃўрЃА рЃњрЃљрЃЏрЃЮрЃАрЃљрЃбрЃљрЃюрЃљрЃЊ.

```c
// In ui_manager.c

void render_home_screen(ui_manager_private_data_t *private_data) {
    char time_str[9];
    time_t now;

    // 1. Check if service exists AND if time is successfully retrieved
    if (private_data->time_sync && private_data->time_sync->get_time(&now) == ESP_OK) {
        struct tm timeinfo;
        localtime_r(&now, &timeinfo); // Converts UTC to local time using TZ variable
        strftime(time_str, sizeof(time_str), "%H:%M", &timeinfo);
    } else {
        // Fallback if service is missing OR time is not yet synced
        strcpy(time_str, "--:--");
    }

    // 2. Render the time string
    draw_large_digits_string(private_data, ..., time_str, 1);
}
```
