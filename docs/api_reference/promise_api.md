# Synapse Promise Manager API Reference

## 🎯 მიზანი

ეს დოკუმენტი აღწერს `Promise Manager`-ის API-ს, რომელიც ხელმისაწვდომია `synapse.h` ჰედერის მეშვეობით. ეს API იყოფა ორ ნაწილად:

1. **Consumer Types:** `callback` ფუნქციების ტიპები, რომლებსაც მომხმარებელი მოდულები (`consumers`) ქმნიან და გადასცემენ ასინქრონულ API ფუნქციებს.
2. **Provider API:** ფუნქციები, რომლებსაც სერვისის მომწოდებელი მოდულები (`providers`) იყენებენ `Promise`-ების შესაქმნელად და შესასრულებლად.

**არქიტექტურული ცვლილება (v2.0.0):** `Promise` პატერნი გამარტივდა. `then()` და `catch()` ფუნქციები ამოღებულია. ამის ნაცვლად, `callback` ფუნქციები პირდაპირ გადაეცემა ასინქრონული ოპერაციის გამშვებ ფუნქციას, რაც სრულად აღმოფხვრის `race condition`-ისა და `deadlock`-ის რისკებს.

---

## 1. Consumer Types (მომხმარებლისთვის)

ეს არის `callback` ფუნქციების ტიპები, რომლებიც უნდა შექმნათ თქვენს მოდულში და გადასცეთ ისეთ ასინქრონულ API ფუნქციებს, როგორიცაა `wifi_api_get_status_async`.

### `promise_then_cb`

ფუნქციის ტიპი, რომელიც გამოიყენება წარმატებული შედეგის დასამუშავებლად.

```c
typedef void (*promise_then_cb)(void* result_data, void* user_context);
```

- **`result_data`**: მაჩვენებელი შედეგის მონაცემებზე. `callback` ფუნქცია პასუხისმგებელია მის სწორ ტიპზე მიყვანაზე (casting). **მნიშვნელოვანია:** `callback`-მა უნდა იცოდეს, `result_data`-ს მეხსიერება დინამიურია თუ სტატიკური.
- **`user_context`**: მომხმარებლის მიერ განსაზღვრული კონტექსტი, რომელიც ასინქრონული ფუნქციის გამოძახებისას გადაეცა.

### `promise_catch_cb`

ფუნქციის ტიპი, რომელიც გამოიყენება შეცდომის დასამუშავებლად.

```c
typedef void (*promise_catch_cb)(void* error_data, void* user_context);
```

- **`error_data`**: მაჩვენებელი შეცდომის აღმწერ მონაცემებზე.
- **`user_context`**: მომხმარებლის კონტექსტი.

---

## 2. Provider API (სერვისის მომწოდებლისთვის)

ეს ფუნქციები განკუთვნილია მხოლოდ იმ მოდულებისთვის, რომლებიც თავად ქმნიან ასინქრონულ, `Promise`-ზე დაფუძნებულ API-ს. მათზე წვდომისთვის საჭიროა `#include "promise_manager_internal.h"`.

### `promise_handle_t synapse_promise_create(promise_then_cb then_cb, promise_catch_cb catch_cb, void* user_context);`

ქმნის ახალ `Promise` ობიექტს `PENDING` (მომლოდინე) მდგომარეობაში, უკვე წინასწარ დარეგისტრირებული `callback` ფუნქციებით.

- **`then_cb`**: (არასავალდებულო) ფუნქცია, რომელიც უნდა გამოიძახოს წარმატების შემთხვევაში.
- **`catch_cb`**: (არასავალდებულო) ფუნქცია, რომელიც უნდა გამოიძახოს შეცდომის შემთხვევაში.
- **`user_context`**: (არასავალდებულო) მაჩვენებელი, რომელიც გადაეცემა `callback` ფუნქციებს.
- **აბრუნებს:** ახალი `Promise`-ის `handle`-ს, ან `NULL` მეხსიერების გამოყოფის შეცდომის შემთხვევაში.

### `esp_err_t synapse_promise_resolve(promise_handle_t handle, void* result_data, void (*free_fn)(void*));`

ასრულებს `Promise`-ს წარმატებით და გადასცემს შედეგს. ეს გამოიწვევს `Promise Manager`-ის მიერ `then_cb` `callback`-ის გამოძახებას.

- **`handle`**: შესასრულებელი `Promise`-ის `handle`.
- **`result_data`**: (არასავალდებულო) მაჩვენებელი შედეგის მონაცემებზე. `Promise Manager`-ი ხდება ამ მონაცემების "მფლობელი".
- **`free_fn`**: (არასავალდებულო) ფუნქცია, რომელიც გამოიყენება `result_data`-ს გასათავისუფლებლად. **თუ `NULL`-ია, `Promise Manager`-ი ჩათვლის, რომ მეხსიერება სტატიკურია და არ შეეცდება მის გათავისუფლებას.**
- **აბრუნებს:** `ESP_OK` თუ `Promise` წარმატებით დაემატა შესრულების რიგში.

### `esp_err_t synapse_promise_reject(promise_handle_t handle, void* error_data, void (*free_fn)(void*));`

ასრულებს `Promise`-ს შეცდომით. ეს გამოიწვევს `catch_cb` `callback`-ის გამოძახებას.

- **`handle`**: შესასრულებელი `Promise`-ის `handle`.
- **`error_data`**: (არასავალდებულო) მაჩვენებელი შეცდომის მონაცემებზე.
- **`free_fn`**: (არასავალდებულო) ფუნქცია `error_data`-ს გასათავისუფლებლად.
- **აბრუნებს:** `ESP_OK` თუ `Promise` წარმატებით დაემატა შესრულების რიგში.

---

## 💡 გამოყენების მაგალითი

იხილეთ [promise_pattern.md](../convention/promise_pattern.md) დეტალური გამოყენების მაგალითისთვის.
