# РўЂ№ИЈ рЃЏрЃЮрЃЊрЃБрЃџрЃў: `mqtt_manager`

**­ЪЌѓ№ИЈ рЃЎрЃљрЃбрЃћрЃњрЃЮрЃарЃўрЃљ:** `communication`  
**Рюњ№ИЈ рЃљрЃЋрЃбрЃЮрЃарЃў:** Synapse Framework Team  
**­Ъћќ рЃЋрЃћрЃарЃАрЃўрЃљ:** 1.3.0

## 1. ­ЪЊю рЃЏрЃўрЃЏрЃЮрЃ«рЃўрЃџрЃЋрЃљ

`mqtt_manager` рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃарЃўрЃА Synapse Framework-рЃўрЃА рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў **рЃАрЃљрЃЎрЃЮрЃЏрЃБрЃюрЃўрЃЎрЃљрЃфрЃўрЃЮ рЃ«рЃўрЃЊрЃў** рЃњрЃљрЃарЃћ рЃАрЃљрЃЏрЃДрЃљрЃарЃЮрЃАрЃЌрЃљрЃю MQTT рЃърЃарЃЮрЃбрЃЮрЃЎрЃЮрЃџрЃўрЃА рЃАрЃљрЃерЃБрЃљрЃџрЃћрЃЉрЃўрЃЌ. рЃўрЃА рЃљрЃа рЃљрЃарЃўрЃА рЃБрЃЉрЃарЃљрЃџрЃЮрЃЊ MQTT рЃЎрЃџрЃўрЃћрЃюрЃбрЃў; рЃўрЃА рЃљрЃарЃўрЃА **рЃўрЃюрЃбрЃћрЃџрЃћрЃЦрЃбрЃБрЃљрЃџрЃБрЃарЃў рЃерЃБрЃљрЃЏрЃљрЃЋрЃљрЃџрЃў**, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃАрЃарЃБрЃџрЃљрЃЊ рЃўрЃюрЃбрЃћрЃњрЃарЃўрЃарЃћрЃЉрЃБрЃџрЃўрЃљ рЃцрЃарЃћрЃўрЃЏрЃЋрЃЮрЃарЃЦрЃўрЃА рЃўрЃќрЃЮрЃџрЃўрЃарЃћрЃЉрЃБрЃџ, рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃќрЃћ рЃЊрЃљрЃцрЃБрЃФрЃюрЃћрЃЉрЃБрЃџ рЃљрЃарЃЦрЃўрЃбрЃћрЃЦрЃбрЃБрЃарЃљрЃАрЃЌрЃљрЃю.

рЃЏрЃўрЃАрЃў рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃљрЃЏрЃЮрЃфрЃљрЃюрЃћрЃЉрЃўрЃљ:

- **­Ъїљ рЃАрЃљрЃўрЃЏрЃћрЃЊрЃЮ рЃЎрЃљрЃЋрЃерЃўрЃарЃўрЃА рЃЏрЃљрЃарЃЌрЃЋрЃљ:** WiFi рЃЎрЃљрЃЋрЃерЃўрЃарЃўрЃА рЃЊрЃљрЃЏрЃДрЃљрЃарЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ, рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃБрЃЎрЃљрЃЋрЃерЃўрЃарЃЊрЃћрЃЉрЃљ MQTT рЃЉрЃарЃЮрЃЎрЃћрЃарЃА рЃЊрЃљ рЃБрЃќрЃарЃБрЃюрЃЋрЃћрЃџрЃДрЃЮрЃцрЃА рЃЎрЃљрЃЋрЃерЃўрЃарЃўрЃА рЃАрЃбрЃљрЃЉрЃўрЃџрЃБрЃарЃЮрЃЉрЃљрЃА `Last Will and Testament` (LWT) рЃЊрЃљ рЃърЃћрЃарЃўрЃЮрЃЊрЃБрЃџрЃў "heartbeat" рЃЏрЃћрЃЦрЃљрЃюрЃўрЃќрЃЏрЃћрЃЉрЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃЌ.
- **­Ъєћ рЃБрЃюрЃўрЃЎрЃљрЃџрЃБрЃарЃў рЃўрЃЊрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃљ:** рЃўрЃДрЃћрЃюрЃћрЃЉрЃА `Device Identity Service`-рЃА, рЃарЃљрЃЌрЃљ рЃерЃћрЃЦрЃЏрЃюрЃљрЃА рЃБрЃюрЃўрЃЎрЃљрЃџрЃБрЃарЃў `ClientID` рЃЊрЃљ рЃЌрЃћрЃЏрЃћрЃЉрЃўрЃА (topics) рЃўрЃћрЃарЃљрЃарЃЦрЃўрЃљ рЃЌрЃўрЃЌрЃЮрЃћрЃБрЃџрЃў рЃЏрЃЮрЃгрЃДрЃЮрЃЉрЃўрЃџрЃЮрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА.
- **РъА№ИЈ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃўрЃА рЃњрЃљрЃЊрЃљрЃЏрЃўрЃАрЃљрЃЏрЃљрЃарЃЌрЃћрЃЉрЃљ (Command Forwarding):** рЃўрЃдрЃћрЃЉрЃА рЃЊрЃўрЃАрЃбрЃљрЃюрЃфрЃўрЃБрЃа рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃА рЃАрЃърЃћрЃфрЃўрЃљрЃџрЃБрЃарЃў MQTT рЃЌрЃћрЃЏрЃўрЃЊрЃљрЃю рЃЊрЃљ "рЃЌрЃљрЃарЃњрЃЏрЃюрЃўрЃА" рЃЏрЃљрЃЌ рЃцрЃарЃћрЃўрЃЏрЃЋрЃЮрЃарЃЦрЃўрЃА рЃерЃўрЃЊрЃљ `SYNAPSE_EVENT_EXECUTE_COMMAND_STRING` рЃўрЃЋрЃћрЃюрЃЌрЃљрЃЊ, рЃўрЃАрЃћ рЃарЃЮрЃЏ рЃљрЃа "рЃўрЃфрЃўрЃА" рЃљрЃЏ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃўрЃА рЃерЃўрЃюрЃљрЃљрЃарЃАрЃў.
- **РгЁ№ИЈ рЃАрЃбрЃљрЃбрЃБрЃАрЃћрЃЉрЃўрЃА рЃњрЃљрЃЏрЃЮрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃљ (Status Publishing):** рЃБрЃАрЃЏрЃћрЃюрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃерЃўрЃЊрЃљ, рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџ рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃА (рЃЏрЃљрЃњ., `SYNAPSE_EVENT_RELAY_STATE_CHANGED`) рЃЊрЃљ рЃљрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃА рЃЏрЃљрЃЌ рЃерЃћрЃАрЃљрЃЉрЃљрЃЏрЃўрЃА, рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃњрЃћрЃюрЃћрЃарЃўрЃарЃћрЃЉрЃБрЃџ рЃЊрЃљ рЃЊрЃўрЃюрЃљрЃЏрЃўрЃБрЃарЃљрЃЊ рЃљрЃгрЃДрЃЮрЃЉрЃўрЃџ MQTT рЃЌрЃћрЃЏрЃћрЃЉрЃќрЃћ.

## 2. ­ЪЈЏ№ИЈ рЃљрЃарЃЦрЃўрЃбрЃћрЃЦрЃбрЃБрЃарЃБрЃџрЃў рЃърЃарЃўрЃюрЃфрЃўрЃърЃћрЃЉрЃў

рЃћрЃА рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃарЃўрЃА рЃцрЃарЃћрЃўрЃЏрЃЋрЃЮрЃарЃЦрЃўрЃА рЃФрЃўрЃарЃўрЃЌрЃљрЃЊрЃў рЃцрЃўрЃџрЃЮрЃАрЃЮрЃцрЃўрЃўрЃА рЃўрЃЊрЃћрЃљрЃџрЃБрЃарЃў рЃњрЃљрЃюрЃАрЃљрЃ«рЃўрЃћрЃарЃћрЃЉрЃљ.

- **рЃАрЃарЃБрЃџрЃў рЃЊрЃћрЃЎрЃљрЃърЃџрЃўрЃюрЃњрЃў (Total Decoupling):** `mqtt_manager`-рЃЏрЃљ **рЃљрЃарЃљрЃцрЃћрЃарЃў рЃўрЃфрЃўрЃА** `relay_actuator`-рЃўрЃА, `wifi_manager`-рЃўрЃА рЃљрЃю рЃюрЃћрЃЉрЃўрЃАрЃЏрЃўрЃћрЃарЃў рЃАрЃ«рЃЋрЃљ рЃцрЃБрЃюрЃЦрЃфрЃўрЃЮрЃюрЃљрЃџрЃБрЃарЃў рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃерЃўрЃЊрЃљ рЃџрЃЮрЃњрЃўрЃЎрЃўрЃА рЃерЃћрЃАрЃљрЃ«рЃћрЃЉ. рЃўрЃА рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃўрЃдрЃћрЃЉрЃА рЃЊрЃљ рЃљрЃњрЃќрЃљрЃЋрЃюрЃўрЃА рЃАрЃбрЃљрЃюрЃЊрЃљрЃарЃбрЃўрЃќрЃћрЃЉрЃБрЃџ рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃћрЃЉрЃА.
- **рЃАрЃћрЃарЃЋрЃўрЃАрЃћрЃЉрЃўрЃА рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃћрЃџрЃў (Service Consumer):** рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃарЃўрЃА рЃАрЃ«рЃЋрЃљ рЃцрЃБрЃюрЃЊрЃљрЃЏрЃћрЃюрЃбрЃБрЃарЃў рЃАрЃћрЃарЃЋрЃўрЃАрЃћрЃЉрЃўрЃА рЃљрЃЦрЃбрЃўрЃБрЃарЃў рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃћрЃџрЃў, рЃарЃЮрЃњрЃЮрЃарЃўрЃфрЃљрЃљ `Device Identity Service`.
- **рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃќрЃћ рЃЊрЃљрЃцрЃБрЃФрЃюрЃћрЃЉрЃБрЃџрЃў рЃџрЃЮрЃњрЃўрЃЎрЃљ:** рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃЌрЃўрЃЌрЃЦрЃЏрЃўрЃА рЃДрЃЋрЃћрЃџрЃљ рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃљ рЃљрЃарЃўрЃА рЃарЃћрЃљрЃЦрЃфрЃўрЃљ `Event Bus`-рЃќрЃћ рЃЏрЃЮрЃЏрЃ«рЃЊрЃљрЃа рЃўрЃЋрЃћрЃюрЃЌрЃќрЃћ. рЃўрЃА рЃљрЃа рЃўрЃдрЃћрЃЉрЃА рЃњрЃљрЃЊрЃљрЃгрЃДрЃЋрЃћрЃбрЃўрЃџрЃћрЃЉрЃћрЃЉрЃА, рЃљрЃарЃљрЃЏрЃћрЃЊ рЃарЃћрЃљрЃњрЃўрЃарЃћрЃЉрЃА.
- **"рЃўрЃЋрЃћрЃюрЃЌрЃў-рЃЌрЃћрЃЏрЃўрЃА рЃарЃБрЃЎрЃљ" (Event-to-Topic Map):** рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃўрЃДрЃћрЃюрЃћрЃЉрЃА рЃерЃўрЃЊрЃљ `event_topic_map` рЃЏрЃљрЃАрЃўрЃЋрЃА, рЃарЃљрЃЌрЃљ рЃўрЃфрЃЮрЃЊрЃћрЃА, рЃарЃЮрЃЏрЃћрЃџрЃў рЃерЃўрЃЊрЃљ рЃўрЃЋрЃћрЃюрЃЌрЃў рЃарЃЮрЃЏрЃћрЃџ рЃњрЃљрЃарЃћ MQTT рЃЌрЃћрЃЏрЃўрЃА рЃерЃљрЃЉрЃџрЃЮрЃюрЃќрЃћ рЃБрЃюрЃЊрЃљ рЃњрЃљрЃЏрЃЮрЃљрЃЦрЃЋрЃћрЃДрЃюрЃЮрЃА. рЃћрЃА рЃ«рЃЊрЃўрЃА рЃАрЃбрЃљрЃбрЃБрЃАрЃћрЃЉрЃўрЃА рЃњрЃљрЃЏрЃЮрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃўрЃА рЃџрЃЮрЃњрЃўрЃЎрЃљрЃА рЃфрЃћрЃюрЃбрЃарЃљрЃџрЃўрЃќрЃћрЃЉрЃБрЃџрЃА рЃЊрЃљ рЃљрЃЊрЃЋрЃўрЃџрЃљрЃЊ рЃњрЃљрЃцрЃљрЃарЃЌрЃЮрЃћрЃЉрЃљрЃЊрЃА.
- **рЃЊрЃўрЃюрЃљрЃЏрЃўрЃБрЃарЃў рЃЌрЃћрЃЏрЃћрЃЉрЃўрЃА рЃњрЃћрЃюрЃћрЃарЃљрЃфрЃўрЃљ:** **(рЃљрЃ«рЃљрЃџрЃў!)** рЃЏрЃЮрЃЊрЃБрЃџрЃА рЃерЃћрЃБрЃФрЃџрЃўрЃљ, рЃљрЃљрЃгрЃДрЃЮрЃА MQTT рЃЌрЃћрЃЏрЃћрЃЉрЃў, рЃарЃЮрЃЏрЃџрЃћрЃЉрЃўрЃф рЃерЃћрЃўрЃфрЃљрЃЋрЃА `{module_name}` placeholder-рЃА. рЃўрЃА рЃљрЃЏ placeholder-рЃА рЃфрЃЋрЃџрЃўрЃА рЃўрЃЋрЃћрЃюрЃЌрЃўрЃА `payload`-рЃерЃў рЃЏрЃЮрЃАрЃБрЃџрЃў рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА `instance_name`-рЃўрЃЌ, рЃарЃљрЃф рЃАрЃљрЃерЃБрЃљрЃџрЃћрЃЉрЃљрЃА рЃўрЃФрЃџрЃћрЃЋрЃљ, рЃћрЃарЃЌрЃў рЃўрЃЋрЃћрЃюрЃЌрЃўрЃЌ (`SYNAPSE_EVENT_RELAY_STATE_CHANGED`) рЃЋрЃЏрЃљрЃарЃЌрЃЮрЃЌ рЃЏрЃарЃљрЃЋрЃљрЃџрЃў рЃАрЃ«рЃЋрЃљрЃЊрЃљрЃАрЃ«рЃЋрЃљ рЃарЃћрЃџрЃћрЃА рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃњрЃљрЃЏрЃЮрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃљ.

## 3. РџЎ№ИЈ рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ

рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃАрЃарЃБрЃџрЃў рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ рЃ«рЃЊрЃћрЃЉрЃљ `system_config.json` рЃцрЃљрЃўрЃџрЃерЃў.

**рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў:**

```json
{
    "type": "mqtt_manager",
    "enabled": true,
    "config": {
        "instance_name": "main_mqtt_broker",
        "broker_uri": "mqtts://your-broker.com:8883",
        "username": "your-username",
        "password": "your-password",
        "lwt_qos": 1,
        "lwt_retain": true
    }
}
```

**рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃћрЃЉрЃў:**

| рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃў | рЃбрЃўрЃърЃў | рЃљрЃдрЃгрЃћрЃарЃљ | рЃАрЃљрЃЋрЃљрЃџрЃЊрЃћрЃЉрЃБрЃџрЃЮ |
| :--- | :--- | :--- | :---: |
| `instance_name` | рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў | рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃўрЃюрЃАрЃбрЃљрЃюрЃфрЃўрЃўрЃА рЃБрЃюрЃўрЃЎрЃљрЃџрЃБрЃарЃў рЃАрЃљрЃ«рЃћрЃџрЃў. | РюЁ |
| `broker_uri` | рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў | MQTT рЃЉрЃарЃЮрЃЎрЃћрЃарЃўрЃА рЃАрЃарЃБрЃџрЃў рЃЏрЃўрЃАрЃљрЃЏрЃљрЃарЃЌрЃў (рЃЏрЃљрЃњ., `mqtt://` рЃљрЃю `mqtts://`). | РюЁ |
| `username` | рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў | рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃџрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў рЃљрЃЋрЃЌрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃўрЃАрЃЌрЃЋрЃўрЃА. | РЮї |
| `password` | рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў | рЃърЃљрЃарЃЮрЃџрЃў рЃљрЃЋрЃЌрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃўрЃАрЃЌрЃЋрЃўрЃА. | РЮї |
| `lwt_qos` | рЃарЃўрЃфрЃ«рЃЋрЃў | Last Will and Testament рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃўрЃА QoS рЃЊрЃЮрЃюрЃћ. | РЮї (Default: `1`) |
| `lwt_retain` | boolean | LWT рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃўрЃА `retain` рЃцрЃџрЃљрЃњрЃў. | РЮї (Default: `true`) |

**рЃерЃћрЃюрЃўрЃерЃЋрЃюрЃљ:** `base_topic_prefix` рЃЊрЃљ `lwt_topic` рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃћрЃЉрЃў рЃљрЃЏрЃЮрЃдрЃћрЃЉрЃБрЃџрЃўрЃљ, рЃарЃљрЃЊрЃњрЃљрЃю рЃЌрЃћрЃЏрЃћрЃЉрЃў рЃљрЃ«рЃџрЃљ рЃАрЃарЃБрЃџрЃљрЃЊ рЃўрЃЏрЃљрЃарЃЌрЃћрЃЉрЃљ `mqtt_topics_generated.h`-рЃўрЃА рЃЏрЃћрЃерЃЋрЃћрЃЮрЃЉрЃўрЃЌ.

## 4. ­ЪЊА MQTT рЃЌрЃћрЃЏрЃћрЃЉрЃўрЃА рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ (Topic Structure)

рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃўрЃДрЃћрЃюрЃћрЃЉрЃА рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃўрЃарЃћрЃЉрЃБрЃџ, рЃўрЃћрЃарЃљрЃарЃЦрЃўрЃБрЃџ рЃЌрЃћрЃЏрЃћрЃЉрЃА, рЃарЃЮрЃЏрЃџрЃћрЃЉрЃўрЃф **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃњрЃћрЃюрЃћрЃарЃўрЃарЃЊрЃћрЃЉрЃљ** build-рЃўрЃА рЃЊрЃарЃЮрЃА `module.json` рЃцрЃљрЃўрЃџрЃћрЃЉрЃерЃў рЃљрЃдрЃгрЃћрЃарЃўрЃџрЃў `mqtt_interface` рЃАрЃћрЃЦрЃфрЃўрЃћрЃЉрЃўрЃА рЃЏрЃўрЃ«рЃћрЃЊрЃЋрЃўрЃЌ.

**рЃАрЃљрЃЉрЃљрЃќрЃўрЃАрЃЮ рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ:** `synapse/devices/{device_id}/{sub_topic}`

**рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў (`device_id` = `5C013B7246E4`):**

- **РъА№ИЈ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃўрЃА рЃЏрЃўрЃАрЃљрЃдрЃћрЃЉрЃљрЃЊ (Inbound):**
  - **рЃЌрЃћрЃЏрЃљ:** `synapse/devices/5C013B7246E4/cmd/in`
  - **рЃљрЃдрЃгрЃћрЃарЃљ:** рЃћрЃА рЃљрЃарЃўрЃА рЃћрЃарЃЌрЃљрЃЊрЃћрЃарЃЌрЃў рЃЌрЃћрЃЏрЃљ, рЃарЃЮрЃЏрЃћрЃџрЃАрЃљрЃф `mqtt_manager` рЃњрЃљрЃЏрЃЮрЃўрЃгрЃћрЃарЃА рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃўрЃА рЃЏрЃўрЃАрЃљрЃдрЃћрЃЉрЃљрЃЊ.
  - **Payload:** рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў, рЃЏрЃљрЃњ., `"relay main_light on"`.

- **РгЁ№ИЈ рЃАрЃбрЃљрЃбрЃБрЃАрЃћрЃЉрЃўрЃА рЃњрЃљрЃЏрЃЮрЃАрЃљрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃџрЃљрЃЊ (Outbound):**
  - **рЃЌрЃћрЃЏрЃљ (рЃЊрЃўрЃюрЃљрЃЏрЃўрЃБрЃарЃў):** `synapse/devices/5C013B7246E4/state/relay/main_light/status`
  - **рЃљрЃдрЃгрЃћрЃарЃљ:** рЃљрЃЏ рЃЌрЃћрЃЏрЃљрЃќрЃћ рЃЦрЃЋрЃћрЃДрЃюрЃЊрЃћрЃЉрЃљ рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў рЃарЃћрЃџрЃћрЃА рЃАрЃбрЃљрЃбрЃБрЃАрЃў, рЃарЃЮрЃЊрЃћрЃАрЃљрЃф `relay_actuator` рЃљрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃА `SYNAPSE_EVENT_RELAY_STATE_CHANGED` рЃўрЃЋрЃћрЃюрЃЌрЃА. `mqtt_manager` рЃўрЃдрЃћрЃЉрЃА `module_name`-рЃА (`"main_light"`) рЃўрЃЋрЃћрЃюрЃЌрЃўрЃА `payload`-рЃўрЃЊрЃљрЃю рЃЊрЃљ рЃљрЃгрЃДрЃЮрЃЉрЃА рЃАрЃљрЃЉрЃЮрЃџрЃЮрЃЮ рЃЌрЃћрЃЏрЃљрЃА.
  - **Payload:** `{"state":"on"}`

- **­Ъћ┤ LWT (Last Will and Testament):**
  - **рЃЌрЃћрЃЏрЃљ:** `synapse/devices/5C013B7246E4/lwt`
  - **Payload:** `{"status":"offline"}`

## 5. ­ЪДа рЃўрЃЏрЃърЃџрЃћрЃЏрЃћрЃюрЃбрЃљрЃфрЃўрЃўрЃА рЃџрЃЮрЃњрЃўрЃЎрЃљ

### 5.1. `init` рЃцрЃљрЃќрЃљ

1. **рЃњрЃљрЃЏрЃЮрЃўрЃгрЃћрЃарЃћрЃЌ `WIFI_EVENT_IP_ASSIGNED` рЃўрЃЋрЃћрЃюрЃЌрЃќрЃћ:** рЃћрЃА рЃљрЃарЃўрЃА рЃАрЃўрЃњрЃюрЃљрЃџрЃў, рЃарЃЮрЃЏ рЃЏрЃќрЃљрЃЊ рЃЋрЃљрЃарЃЌ MQTT рЃЎрЃљрЃЋрЃерЃўрЃарЃўрЃАрЃЌрЃЋрЃўрЃА.
2. **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃњрЃљрЃЏрЃЮрЃўрЃгрЃћрЃарЃћрЃЌ рЃДрЃЋрЃћрЃџрЃљ рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃўрЃЋрЃћрЃюрЃЌрЃќрЃћ:** `init` рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ рЃњрЃљрЃЊрЃўрЃА `event_topic_map` рЃЏрЃљрЃАрЃўрЃЋрЃА рЃЊрЃљ рЃњрЃљрЃЏрЃЮрЃўрЃгрЃћрЃарЃА рЃДрЃЋрЃћрЃџрЃљ рЃўрЃЦ рЃљрЃдрЃгрЃћрЃарЃўрЃџ рЃўрЃЋрЃћрЃюрЃЌрЃА.

### 5.2. `handle_event` рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ

рЃћрЃА рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ рЃљрЃарЃўрЃА рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА "рЃњрЃБрЃџрЃў".

- **рЃЌрЃБ рЃўрЃЋрЃћрЃюрЃЌрЃў рЃљрЃарЃўрЃА `WIFI_EVENT_IP_ASSIGNED`:**
  - рЃўрЃгрЃДрЃћрЃЉрЃА MQTT рЃЎрЃџрЃўрЃћрЃюрЃбрЃўрЃА рЃўрЃюрЃўрЃфрЃўрЃљрЃџрЃўрЃќрЃљрЃфрЃўрЃўрЃАрЃљ рЃЊрЃљ рЃЎрЃљрЃЋрЃерЃўрЃарЃўрЃА рЃЊрЃљрЃЏрЃДрЃљрЃарЃћрЃЉрЃўрЃА рЃърЃарЃЮрЃфрЃћрЃАрЃА.
- **рЃЌрЃБ рЃўрЃЋрЃћрЃюрЃЌрЃў рЃљрЃарЃўрЃА `event_topic_map`-рЃерЃў рЃљрЃдрЃгрЃћрЃарЃўрЃџрЃў рЃарЃЮрЃЏрЃћрЃџрЃўрЃЏрЃћ рЃАрЃ«рЃЋрЃљ рЃўрЃЋрЃћрЃюрЃЌрЃў:**
    1. рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА, рЃљрЃарЃўрЃА рЃЌрЃБ рЃљрЃарЃљ MQTT рЃЎрЃџрЃўрЃћрЃюрЃбрЃў рЃЊрЃљрЃЎрЃљрЃЋрЃерЃўрЃарЃћрЃЉрЃБрЃџрЃў.
    2. рЃўрЃдрЃћрЃЉрЃА `synapse_telemetry_payload_t` рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљрЃА рЃўрЃЋрЃћрЃюрЃЌрЃўрЃЊрЃљрЃю.
    3. рЃърЃЮрЃБрЃџрЃЮрЃЉрЃА рЃерЃћрЃАрЃљрЃЉрЃљрЃЏрЃўрЃА MQTT рЃЌрЃћрЃЏрЃўрЃА рЃерЃљрЃЉрЃџрЃЮрЃюрЃА "рЃарЃБрЃЎрЃўрЃЊрЃљрЃю".
    4. **рЃЌрЃБ рЃерЃљрЃЉрЃџрЃЮрЃюрЃў рЃерЃћрЃўрЃфрЃљрЃЋрЃА `{module_name}`-рЃА, рЃфрЃЋрЃџрЃўрЃА рЃЏрЃљрЃА `payload`-рЃўрЃЊрЃљрЃю рЃЏрЃЮрЃАрЃБрЃџрЃў `module_name`-рЃўрЃЌ.**
    5. `MQTT_BUILD_TOPIC` рЃЏрЃљрЃЎрЃарЃЮрЃАрЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃЌ рЃљрЃњрЃћрЃЉрЃА рЃАрЃарЃБрЃџ рЃЌрЃћрЃЏрЃљрЃА `device_id`-рЃўрЃА рЃЕрЃљрЃАрЃЏрЃўрЃЌ.
    6. рЃљрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃА `payload`-рЃўрЃА `json_data`-рЃА рЃљрЃЏ рЃЌрЃћрЃЏрЃљрЃќрЃћ.

### 5.3. `mqtt_event_handler_cb` (ESP-IDF-рЃўрЃА callback)

- **`MQTT_EVENT_CONNECTED`:**
  - рЃўрЃгрЃћрЃарЃА `.../cmd/in` рЃЌрЃћрЃЏрЃљрЃА.
  - рЃњрЃћрЃњрЃЏрЃљрЃЋрЃА рЃърЃћрЃарЃўрЃЮрЃЊрЃБрЃџ "heartbeat" рЃўрЃЋрЃћрЃюрЃЌрЃА `System Timer Service`-рЃўрЃА рЃЏрЃћрЃерЃЋрЃћрЃЮрЃЉрЃўрЃЌ.
- **`MQTT_EVENT_DATA` (рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ рЃЏрЃЮрЃЋрЃўрЃЊрЃљ):**
  - рЃўрЃдрЃћрЃЉрЃА рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃА рЃЊрЃљ рЃљрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃА `SYNAPSE_EVENT_EXECUTE_COMMAND_STRING` рЃўрЃЋрЃћрЃюрЃЌрЃА.

## 6. РЮЌ рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃў рЃерЃћрЃюрЃўрЃерЃЋрЃюрЃћрЃЉрЃў

- **рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮрЃћрЃЉрЃљ:** рЃарЃћрЃљрЃџрЃБрЃа рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃерЃў, рЃДрЃЮрЃЋрЃћрЃџрЃЌрЃЋрЃўрЃА рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћрЃЌ `mqtts://` (TLS) рЃЊрЃљ рЃФрЃџрЃўрЃћрЃарЃў `username`/`password`.
- **`init_level`:** рЃљрЃЏ рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА `init_level` (`45`) рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџрЃўрЃљ. рЃўрЃА рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА `wifi_manager`-рЃўрЃА (`40`) рЃЊрЃљ `device_identity_service`-рЃўрЃА (`22`) рЃерЃћрЃЏрЃЊрЃћрЃњ, рЃарЃљрЃЌрЃљ рЃЏрЃљрЃЌрЃў рЃАрЃћрЃарЃЋрЃўрЃАрЃћрЃЉрЃў рЃ«рЃћрЃџрЃЏрЃўрЃАрЃљрЃгрЃЋрЃЊрЃЮрЃЏрЃў рЃўрЃДрЃЮрЃА.
