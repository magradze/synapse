# ­ЪЕ║ рЃЏрЃЮрЃЊрЃБрЃџрЃў: Health Monitor

**­ЪЌѓ№ИЈ рЃЎрЃљрЃбрЃћрЃњрЃЮрЃарЃўрЃљ:** `system`  
**Рюњ№ИЈ рЃљрЃЋрЃбрЃЮрЃарЃў:** Synapse Framework Team  
**­Ъћќ рЃЋрЃћрЃарЃАрЃўрЃљ:** 2.0.0

## 1. ­ЪЊю рЃЏрЃўрЃЏрЃЮрЃ«рЃўрЃџрЃЋрЃљ

`Health Monitor` рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃарЃўрЃА Synapse Framework-рЃўрЃА **рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃЏрЃЊрЃњрЃарЃљрЃЊрЃЮрЃЉрЃўрЃА рЃЏрЃфрЃЋрЃћрЃџрЃў**. рЃЏрЃўрЃАрЃў рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃљрЃЏрЃЮрЃфрЃљрЃюрЃљрЃљ, рЃцрЃЮрЃюрЃБрЃа рЃарЃћрЃЪрЃўрЃЏрЃерЃў, рЃарЃћрЃљрЃџрЃБрЃа рЃЊрЃарЃЮрЃерЃў рЃљрЃЎрЃЮрЃюрЃбрЃарЃЮрЃџрЃЮрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџрЃў рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃћрЃЉрЃў, рЃљрЃдрЃЏрЃЮрЃљрЃЕрЃўрЃюрЃЮрЃА рЃърЃЮрЃбрЃћрЃюрЃфрЃўрЃБрЃарЃў рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃћрЃЉрЃў (рЃарЃЮрЃњрЃЮрЃарЃўрЃфрЃљрЃљ рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃўрЃА рЃњрЃљрЃЪрЃЮрЃюрЃЋрЃљ рЃљрЃю рЃбрЃљрЃАрЃЎрЃћрЃЉрЃўрЃА рЃАрЃбрЃћрЃЎрЃўрЃА рЃњрЃљрЃЊрЃљрЃЋрЃАрЃћрЃЉрЃљ) рЃЏрЃљрЃЌ рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџ рЃцрЃљрЃќрЃљрЃерЃў рЃњрЃљрЃЊрЃљрЃАрЃЋрЃџрЃљрЃЏрЃЊрЃћ рЃЊрЃљ рЃерЃћрЃљрЃбрЃДрЃЮрЃЉрЃўрЃюрЃЮрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃАрЃ«рЃЋрЃљ рЃюрЃљрЃгрЃўрЃџрЃћрЃЉрЃА рЃЏрЃЮрЃАрЃљрЃџрЃЮрЃЊрЃюрЃћрЃџрЃў рЃАрЃљрЃцрЃарЃЌрЃ«рЃўрЃА рЃерЃћрЃАрЃљрЃ«рЃћрЃЉ.

рЃћрЃА рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃарЃўрЃА рЃърЃарЃћрЃЋрЃћрЃюрЃфрЃўрЃБрЃџрЃў рЃЊрЃўрЃљрЃњрЃюрЃЮрЃАрЃбрЃўрЃЎрЃўрЃА рЃцрЃБрЃюрЃЊрЃљрЃЏрЃћрЃюрЃбрЃБрЃарЃў рЃўрЃюрЃАрЃбрЃарЃБрЃЏрЃћрЃюрЃбрЃў, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃюрЃљрЃЊ рЃќрЃарЃЊрЃўрЃА рЃЏрЃЮрЃгрЃДрЃЮрЃЉрЃўрЃџрЃЮрЃЉрЃўрЃА рЃАрЃљрЃўрЃЏрЃћрЃЊрЃЮрЃЮрЃЉрЃљрЃА рЃњрЃарЃФрЃћрЃџрЃЋрЃљрЃЊрЃўрЃљрЃю рЃърЃћрЃарЃАрЃърЃћрЃЦрЃбрЃўрЃЋрЃљрЃерЃў.

## 2. РЮЌ рЃгрЃўрЃюрЃљрЃърЃўрЃарЃЮрЃЉрЃћрЃЉрЃў рЃЊрЃљ `menuconfig`

рЃљрЃЏ рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃАрЃарЃБрЃџрЃў рЃцрЃБрЃюрЃЦрЃфрЃўрЃЮрЃюрЃўрЃарЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА, рЃњрЃљрЃюрЃАрЃљрЃЎрЃБрЃЌрЃарЃћрЃЉрЃўрЃЌ рЃбрЃљрЃАрЃЎрЃћрЃЉрЃўрЃА рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃЏрЃЮрЃюрЃўрЃбрЃЮрЃарЃўрЃюрЃњрЃўрЃАрЃЌрЃЋрЃўрЃА, рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ ESP-IDF-рЃўрЃА рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљрЃерЃў (`menuconfig`) рЃерЃћрЃЏрЃЊрЃћрЃњрЃў рЃЮрЃцрЃфрЃўрЃћрЃЉрЃўрЃА рЃЕрЃљрЃарЃЌрЃЋрЃљ:

1. рЃњрЃљрЃБрЃерЃЋрЃўрЃЌ `idf.py menuconfig`.
2. рЃњрЃљрЃЊрЃљрЃЊрЃўрЃЌ `Component config` ---> `FreeRTOS` --->
3. рЃЕрЃљрЃарЃЌрЃћрЃЌ (`[y]`) рЃерЃћрЃЏрЃЊрЃћрЃњрЃў рЃЮрЃцрЃфрЃўрЃљ:
    * `Enable generation of run time stats`

**рЃњрЃљрЃцрЃарЃЌрЃ«рЃўрЃџрЃћрЃЉрЃљ:** рЃљрЃЏ рЃЮрЃцрЃфрЃўрЃўрЃА рЃЕрЃљрЃарЃЌрЃЋрЃўрЃА рЃњрЃљрЃарЃћрЃерЃћ, `uxTaskGetSystemState` рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ рЃљрЃа рЃўрЃЦрЃюрЃћрЃЉрЃљ рЃ«рЃћрЃџрЃЏрЃўрЃАрЃљрЃгрЃЋрЃЊрЃЮрЃЏрЃў рЃЊрЃљ рЃърЃарЃЮрЃћрЃЦрЃбрЃўрЃА рЃЎрЃЮрЃЏрЃърЃўрЃџрЃљрЃфрЃўрЃљ рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃћрЃЉрЃљ `undefined reference` рЃерЃћрЃфрЃЊрЃЮрЃЏрЃўрЃЌ.

## 3. ­ЪЈЏ№ИЈ рЃљрЃарЃЦрЃўрЃбрЃћрЃЦрЃбрЃБрЃарЃБрЃџрЃў рЃърЃарЃўрЃюрЃфрЃўрЃърЃћрЃЉрЃў

* **рЃарЃћрЃАрЃБрЃарЃАрЃћрЃЉрЃўрЃА рЃЮрЃърЃбрЃўрЃЏрЃўрЃќрЃљрЃфрЃўрЃљ:** рЃЏрЃЮрЃЊрЃБрЃџрЃў **рЃљрЃа рЃЦрЃЏрЃюрЃўрЃА рЃАрЃљрЃЎрЃБрЃЌрЃљрЃа рЃбрЃљрЃАрЃЎрЃА**. рЃљрЃЏрЃўрЃА рЃюрЃљрЃфрЃЋрЃџрЃљрЃЊ, рЃўрЃА рЃЌрЃљрЃЋрЃўрЃА рЃърЃћрЃарЃўрЃЮрЃЊрЃБрЃџ рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃўрЃА рЃџрЃЮрЃњрЃўрЃЎрЃљрЃА рЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃА `core`-рЃўрЃА **`Task Pool Manager`**-рЃерЃў, рЃарЃЮрЃњрЃЮрЃарЃф "рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ" (`Job`). рЃћрЃА рЃЏрЃўрЃЊрЃњрЃЮрЃЏрЃљ рЃќрЃЮрЃњрЃљрЃЋрЃА ~3KB рЃЮрЃърЃћрЃарЃљрЃбрЃўрЃБрЃџ рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃљрЃА рЃЊрЃљ рЃљрЃЏрЃфрЃўрЃарЃћрЃЉрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃАрЃљрЃћрЃарЃЌрЃЮ рЃЊрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃљрЃА.
* **рЃќрЃдрЃЋрЃарЃБрЃџрЃў рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЉрЃћрЃЉрЃў (Thresholds):** рЃДрЃЋрЃћрЃџрЃљ рЃЏрЃЮрЃюрЃўрЃбрЃЮрЃарЃўрЃюрЃњрЃўрЃА рЃЦрЃЋрЃћрЃе рЃЏрЃДрЃЮрЃц рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃА рЃљрЃЦрЃЋрЃА рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃўрЃарЃћрЃЉрЃљрЃЊрЃў рЃќрЃдрЃЋрЃарЃБрЃџрЃў рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЉрЃљ.
* **рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃќрЃћ рЃЊрЃљрЃцрЃБрЃФрЃюрЃћрЃЉрЃБрЃџрЃў рЃарЃћрЃљрЃњрЃўрЃарЃћрЃЉрЃљ:** рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃўрЃА рЃљрЃдрЃЏрЃЮрЃЕрЃћрЃюрЃўрЃАрЃљрЃА, рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃА `SYSTEM_HEALTH_ALERT` рЃўрЃЋрЃћрЃюрЃЌрЃА `Event Bus`-рЃќрЃћ, рЃарЃљрЃќрЃћрЃф рЃАрЃ«рЃЋрЃљ рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃА (рЃЏрЃљрЃњ., `alarms_manager`) рЃерЃћрЃБрЃФрЃџрЃўрЃљрЃЌ рЃарЃћрЃљрЃњрЃўрЃарЃћрЃЉрЃљ.
* **рЃњрЃљрЃцрЃљрЃарЃЌрЃЮрЃћрЃЉрЃљрЃЊрЃЮрЃЉрЃљ:** рЃАрЃ«рЃЋрЃљ рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃА рЃерЃћрЃБрЃФрЃџрЃўрЃљрЃЌ, рЃЊрЃљрЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃЮрЃю рЃАрЃљрЃЎрЃБрЃЌрЃљрЃарЃў "рЃ»рЃљрЃюрЃЏрЃарЃЌрЃћрЃџрЃЮрЃЉрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃўрЃА" рЃцрЃБрЃюрЃЦрЃфрЃўрЃћрЃЉрЃў `Service API`-рЃА рЃЏрЃћрЃерЃЋрЃћрЃЮрЃЉрЃўрЃЌ.
* **рЃЎрЃЮрЃюрЃбрЃћрЃЦрЃАрЃбрЃќрЃћ-рЃЊрЃљрЃЏрЃЮрЃЎрЃўрЃЊрЃћрЃЉрЃБрЃџрЃћрЃЉрЃљ:** рЃЏрЃЮрЃЊрЃБрЃџрЃў "рЃГрЃЎрЃЋрЃўрЃљрЃюрЃўрЃљ" рЃЊрЃљ рЃерЃћрЃБрЃФрЃџрЃўрЃљ, рЃЊрЃарЃЮрЃћрЃЉрЃўрЃЌ рЃњрЃљрЃЌрЃўрЃерЃЮрЃА рЃњрЃљрЃарЃЎрЃЋрЃћрЃБрЃџрЃў рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃћрЃЉрЃў (рЃЏрЃљрЃњ., рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃўрЃА рЃЎрЃЮрЃюрЃбрЃарЃЮрЃџрЃў `provisioning`-рЃўрЃА рЃЊрЃарЃЮрЃА), рЃарЃљрЃЌрЃљ рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃљрЃўрЃфрЃўрЃџрЃЮрЃА рЃфрЃарЃБ рЃњрЃљрЃюрЃњрЃљрЃерЃћрЃЉрЃў.

## 4. РџЎ№ИЈ рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ

рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ рЃ«рЃЊрЃћрЃЉрЃљ рЃЏрЃўрЃАрЃў `config.json` рЃцрЃљрЃўрЃџрЃўрЃА рЃАрЃљрЃерЃБрЃљрЃџрЃћрЃЉрЃўрЃЌ.

**рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў:**

```json
[
    {
        "type": "health_monitor",
        "enabled": true,
        "config": {
            "instance_name": "health_monitor",
            "check_interval_sec": 60,
            "thresholds": {
                "min_free_heap_kb": 20,
                "min_task_stack_hwm_bytes": 256
            }
        }
    }
]
```

**рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃћрЃЉрЃў:**

| рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃў | рЃбрЃўрЃърЃў | рЃљрЃдрЃгрЃћрЃарЃљ | рЃАрЃљрЃЋрЃљрЃџрЃЊрЃћрЃЉрЃБрЃџрЃЮ | Default |
|:---|:---|:---|:---:|:---|
| `instance_name` | рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў | рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃўрЃюрЃАрЃбрЃљрЃюрЃфрЃўрЃўрЃА рЃБрЃюрЃўрЃЎрЃљрЃџрЃБрЃарЃў рЃАрЃљрЃ«рЃћрЃџрЃў. | РюЁ | - |
| `check_interval_sec` | рЃарЃўрЃфрЃ«рЃЋрЃў | рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃўрЃА рЃўрЃюрЃбрЃћрЃарЃЋрЃљрЃџрЃў рЃгрЃљрЃЏрЃћрЃЉрЃерЃў. | РЮї | `60` |
| `thresholds` | рЃЮрЃЉрЃўрЃћрЃЦрЃбрЃў | рЃќрЃдрЃЋрЃарЃБрЃџрЃў рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЉрЃћрЃЉрЃўрЃА рЃЎрЃЮрЃюрЃбрЃћрЃўрЃюрЃћрЃарЃў. | РЮї | - |
| `thresholds.min_free_heap_kb` | рЃарЃўрЃфрЃ«рЃЋрЃў | рЃЌрЃљрЃЋрЃўрЃАрЃБрЃцрЃљрЃџрЃў рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃўрЃА рЃЏрЃўрЃюрЃўрЃЏрЃљрЃџрЃБрЃарЃў рЃќрЃдрЃЋрЃљрЃарЃў рЃЎрЃўрЃџрЃЮрЃЉрЃљрЃўрЃбрЃћрЃЉрЃерЃў. | РЮї | `20` |
| `thresholds.min_task_stack_hwm_bytes` | рЃарЃўрЃфрЃ«рЃЋрЃў | рЃбрЃљрЃАрЃЎрЃўрЃА рЃАрЃбрЃћрЃЎрЃўрЃА рЃЊрЃљрЃарЃЕрЃћрЃюрЃўрЃџрЃў рЃЌрЃљрЃЋрЃўрЃАрЃБрЃцрЃљрЃџрЃў рЃљрЃЊрЃњрЃўрЃџрЃўрЃА рЃЏрЃўрЃюрЃўрЃЏрЃљрЃџрЃБрЃарЃў рЃќрЃдрЃЋрЃљрЃарЃў рЃЉрЃљрЃўрЃбрЃћрЃЉрЃерЃў. | РЮї | `256` |

## 5. ­Ъћї Service API (`health_api_t`)

рЃАрЃ«рЃЋрЃљ рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃА рЃерЃћрЃБрЃФрЃџрЃўрЃљрЃЌ рЃЏрЃўрЃўрЃдрЃЮрЃю рЃгрЃЋрЃЊрЃЮрЃЏрЃљ `Health Monitor`-рЃўрЃА API-рЃќрЃћ `Service Locator`-рЃўрЃА рЃЏрЃћрЃерЃЋрЃћрЃЮрЃЉрЃўрЃЌ. рЃАрЃћрЃарЃЋрЃўрЃАрЃўрЃА рЃбрЃўрЃърЃў: `SYNAPSE_SERVICE_TYPE_HEALTH_API`.

**API рЃцрЃБрЃюрЃЦрЃфрЃўрЃћрЃЉрЃў:**

* **`esp_err_t get_system_health_report(cJSON **report);`**  
    рЃљрЃЉрЃарЃБрЃюрЃћрЃЉрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃ»рЃљрЃюрЃЏрЃарЃЌрЃћрЃџрЃЮрЃЉрЃўрЃА рЃАрЃарЃБрЃџ рЃарЃћрЃърЃЮрЃарЃбрЃА cJSON рЃЮрЃЉрЃўрЃћрЃЦрЃбрЃўрЃА рЃАрЃљрЃ«рЃўрЃЌ. рЃарЃћрЃърЃЮрЃарЃбрЃў рЃерЃћрЃўрЃфрЃљрЃЋрЃА рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљрЃА рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃўрЃА, uptime-рЃўрЃАрЃљ рЃЊрЃљ рЃДрЃЋрЃћрЃџрЃљ рЃљрЃЦрЃбрЃўрЃБрЃарЃў рЃбрЃљрЃАрЃЎрЃўрЃА рЃерЃћрЃАрЃљрЃ«рЃћрЃЉ. **рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃўрЃљ:** рЃњрЃљрЃЏрЃЮрЃЏрЃФрЃљрЃ«рЃћрЃЉрЃћрЃџрЃЏрЃљ рЃБрЃюрЃЊрЃљ рЃњрЃљрЃљрЃЌрЃљрЃЋрЃўрЃАрЃБрЃцрЃџрЃЮрЃА рЃЊрЃљрЃЉрЃарЃБрЃюрЃћрЃЉрЃБрЃџрЃў `cJSON` рЃЮрЃЉрЃўрЃћрЃЦрЃбрЃў `cJSON_Delete()`-рЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃЌ.

* **`esp_err_t register_custom_check(const char* check_name, health_check_fn_t check_fn, void* context);`**  
    рЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃА рЃљрЃ«рЃљрЃџ, рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃџрЃўрЃА рЃЏрЃўрЃћрЃа рЃњрЃљрЃюрЃАрЃљрЃќрЃдрЃЋрЃарЃБрЃџ рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃўрЃА рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃА.

* **`esp_err_t unregister_custom_check(const char* check_name);`**  
    рЃерЃџрЃўрЃА рЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃБрЃџ рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљрЃА.

## 6. ­ЪЊб рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃў

### рЃњрЃљрЃЏрЃЮрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃБрЃџрЃў рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃў

* **`SYSTEM_HEALTH_ALERT`**
  * **рЃарЃЮрЃЊрЃўрЃА рЃЦрЃЋрЃћрЃДрЃюрЃЊрЃћрЃЉрЃљ:** рЃарЃЮрЃЊрЃћрЃАрЃљрЃф рЃарЃЮрЃЏрЃћрЃџрЃўрЃЏрЃћ рЃЏрЃЮрЃюрЃўрЃбрЃЮрЃарЃўрЃюрЃњрЃўрЃА рЃЦрЃЋрЃћрЃе рЃЏрЃДрЃЮрЃцрЃў рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃў рЃњрЃљрЃЊрЃљрЃАрЃфрЃЊрЃћрЃЉрЃљ рЃЊрЃљрЃгрЃћрЃАрЃћрЃЉрЃБрЃџ рЃќрЃдрЃЋрЃљрЃарЃА.
  * **Payload (cJSON рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў):**
    * **рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃўрЃА рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ:** `{"alert_type":"LOW_HEAP_MEMORY", "value_kb":18}`
    * **рЃАрЃбрЃћрЃЎрЃўрЃА рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ:** `{"alert_type":"LOW_STACK_SPACE", "task_name":"some_task", "remaining_bytes":200}`
    * **Custom рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃўрЃА рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ:** `{"alert_type":"CUSTOM_CHECK_FAILED", "check_name":"my_db_check"}`

### рЃњрЃљрЃЏрЃЮрЃгрЃћрЃарЃўрЃџрЃў рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃў

* **`PROV_STARTED`**: рЃљрЃЏ рЃўрЃЋрЃћрЃюрЃЌрЃўрЃА рЃЏрЃўрЃдрЃћрЃЉрЃўрЃАрЃљрЃА, рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃЊрЃарЃЮрЃћрЃЉрЃўрЃЌ рЃЌрЃўрЃерЃљрЃЋрЃА рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљрЃА.
* **`PROV_ENDED`**: рЃљрЃЏ рЃўрЃЋрЃћрЃюрЃЌрЃўрЃА рЃЏрЃўрЃдрЃћрЃЉрЃўрЃАрЃљрЃА, рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃА рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљрЃА.

## 7. ­ЪњА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў

`ota_update_manager`-рЃА рЃАрЃБрЃарЃА, рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљрЃЏрЃЊрЃћ рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃЮрЃА, рЃљрЃарЃўрЃА рЃЌрЃБ рЃљрЃарЃљ рЃАрЃўрЃАрЃбрЃћрЃЏрЃљрЃерЃў рЃАрЃљрЃЎрЃЏрЃљрЃарЃўрЃАрЃў рЃарЃћрЃАрЃБрЃарЃАрЃў.

```c
#include "synapse.h"
#include "health_interface.h"

void start_ota_if_healthy() {
    // рЃЋрЃўрЃДрЃћрЃюрЃћрЃЉрЃЌ lookup_by_type-рЃА, рЃарЃљрЃЌрЃљ рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃљрЃЋрЃўрЃфрЃўрЃџрЃЮрЃЌ hardcoded рЃАрЃљрЃ«рЃћрЃџрЃў
    service_handle_t handle = synapse_service_lookup_by_type(SYNAPSE_SERVICE_TYPE_HEALTH_API);
    if (!handle) {
        ESP_LOGW(TAG, "Health Monitor service not found. Skipping health check.");
        // ... рЃњрЃљрЃюрЃљрЃњрЃарЃФрЃћ OTA ...
        return;
    }

    health_api_t *health_api = (health_api_t *)handle;
    cJSON *report = NULL;
    
    if (health_api->get_system_health_report(&report) == ESP_OK && report) {
        const cJSON *heap = cJSON_GetObjectItem(report, "min_free_heap_bytes");
        
        // рЃерЃћрЃЋрЃљрЃЏрЃЮрЃгрЃЏрЃЮрЃЌ, рЃЌрЃБ рЃЌрЃљрЃЋрЃўрЃАрЃБрЃцрЃљрЃџрЃў рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃљ 80KB-рЃќрЃћ рЃюрЃљрЃЎрЃџрЃћрЃЉрЃўрЃљ
        if (cJSON_IsNumber(heap) && heap->valueint < 80000) { 
            ESP_LOGE(TAG, "Not enough free memory for OTA update. Aborting.");
            cJSON_Delete(report);
            return;
        }
        cJSON_Delete(report);
    }

    // ... рЃАрЃўрЃАрЃбрЃћрЃЏрЃљ рЃ»рЃљрЃюрЃЏрЃарЃЌрЃћрЃџрЃўрЃљ, рЃЋрЃўрЃгрЃДрЃћрЃЉрЃЌ OTA-рЃА ...
}
```
