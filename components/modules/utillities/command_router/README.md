# РџЎ№ИЈ рЃЏрЃЮрЃЊрЃБрЃџрЃў: Command Router & System Shell

**­ЪЌѓ№ИЈ рЃЎрЃљрЃбрЃћрЃњрЃЮрЃарЃўрЃљ:** `utilities`  
**Рюњ№ИЈ рЃљрЃЋрЃбрЃЮрЃарЃў:** Synapse Framework Team  
**­Ъћќ рЃЋрЃћрЃарЃАрЃўрЃљ:** 1.3.1

## 1. ­ЪЊю рЃЏрЃўрЃЏрЃЮрЃ«рЃўрЃџрЃЋрЃљ

`Command Router` рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃарЃўрЃА Synapse Framework-рЃўрЃА **рЃЏрЃљрЃарЃЌрЃЋрЃўрЃА рЃфрЃћрЃюрЃбрЃарЃљрЃџрЃБрЃарЃў рЃЎрЃЋрЃљрЃюрЃФрЃў**. рЃўрЃА рЃБрЃќрЃарЃБрЃюрЃЋрЃћрЃџрЃДрЃЮрЃцрЃА рЃћрЃарЃЌрЃўрЃљрЃю, рЃњрЃљрЃцрЃљрЃарЃЌрЃЮрЃћрЃЉрЃљрЃЊ рЃЊрЃљ рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮ рЃЏрЃћрЃЦрЃљрЃюрЃўрЃќрЃЏрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃарЃў рЃЊрЃљ рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃўрЃА рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃўрЃА рЃЏрЃўрЃАрЃљрЃдрЃћрЃЉрЃљрЃЊ, рЃњрЃљрЃАрЃљрЃърЃљрЃарЃАрЃљрЃЊ рЃЊрЃљ рЃерЃћрЃАрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃџрЃљрЃЊ.

рЃЏрЃўрЃАрЃў рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃЏрЃўрЃќрЃљрЃюрЃўрЃљ, рЃАрЃарЃБрЃџрЃљрЃЊ рЃњрЃљрЃЏрЃўрЃ»рЃюрЃЮрЃА рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА **рЃгрЃДрЃљрЃарЃЮ** (рЃЏрЃљрЃњ., ­Ъњ╗ Serial Console, РўЂ№ИЈ MQTT, ­Ъїљ HTTP, ­Ъћх BLE) рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА **рЃерЃћрЃЏрЃАрЃарЃБрЃџрЃћрЃЉрЃџрЃўрЃАрЃњрЃљрЃю** (рЃЏрЃљрЃњ., `relay_module`, `ota_manager`). рЃћрЃА рЃЦрЃЏрЃюрЃўрЃА рЃБрЃЎрЃўрЃЊрЃБрЃарЃћрЃАрЃљрЃЊ рЃЏрЃЮрЃЦрЃюрЃўрЃџ рЃљрЃарЃЦрЃўрЃбрЃћрЃЦрЃбрЃБрЃарЃљрЃА, рЃАрЃљрЃЊрЃљрЃф рЃюрЃћрЃЉрЃўрЃАрЃЏрЃўрЃћрЃарЃў рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃўрЃЏрЃљрЃарЃЌрЃЮрЃА рЃюрЃћрЃЉрЃўрЃАрЃЏрЃўрЃћрЃарЃў рЃАрЃљрЃЎрЃЮрЃЏрЃБрЃюрЃўрЃЎрЃљрЃфрЃўрЃЮ рЃљрЃарЃ«рЃўрЃЊрЃљрЃю, рЃЎрЃЮрЃЊрЃўрЃА рЃЊрЃБрЃЉрЃџрЃўрЃарЃћрЃЉрЃўрЃА рЃњрЃљрЃарЃћрЃерЃћ.

## 2. ­ЪЈЏ№ИЈ рЃљрЃарЃЦрЃўрЃбрЃћрЃЦрЃбрЃБрЃарЃБрЃџрЃў рЃърЃарЃўрЃюрЃфрЃўрЃърЃћрЃЉрЃў

- **­ЪцЮ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃўрЃА рЃарЃћрЃњрЃўрЃАрЃбрЃарЃљрЃфрЃўрЃўрЃА рЃърЃљрЃбрЃћрЃарЃюрЃў:** рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃў рЃљрЃа рЃљрЃ«рЃЊрЃћрЃюрЃћрЃю рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃўрЃА рЃўрЃЏрЃърЃџрЃћрЃЏрЃћрЃюрЃбрЃљрЃфрЃўрЃљрЃА рЃЌрЃљрЃЋрЃљрЃЊ. рЃљрЃЏрЃўрЃА рЃюрЃљрЃфрЃЋрЃџрЃљрЃЊ, рЃўрЃАрЃўрЃюрЃў рЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃћрЃю рЃЌрЃљрЃЋрЃўрЃљрЃюрЃЌ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃА рЃЊрЃљ рЃерЃћрЃАрЃљрЃЉрЃљрЃЏрЃўрЃА `callback` рЃцрЃБрЃюрЃЦрЃфрЃўрЃћрЃЉрЃА `Command Router`-рЃерЃў рЃЏрЃўрЃАрЃў Service API-рЃА рЃЏрЃћрЃерЃЋрЃћрЃЮрЃЉрЃўрЃЌ.
- **­ЪДЕ рЃљрЃЉрЃАрЃбрЃарЃљрЃЦрЃфрЃўрЃљ рЃЊрЃљ рЃЊрЃћрЃџрЃћрЃњрЃўрЃарЃћрЃЉрЃљ:** `Command Router` рЃўрЃДрЃћрЃюрЃћрЃЉрЃА ESP-IDF-рЃўрЃА рЃАрЃбрЃљрЃюрЃЊрЃљрЃарЃбрЃБрЃџ `esp_console` рЃЎрЃЮрЃЏрЃърЃЮрЃюрЃћрЃюрЃбрЃА, рЃарЃљрЃЌрЃљ рЃАрЃљрЃўрЃЏрЃћрЃЊрЃЮрЃЊ рЃЊрЃљрЃљрЃЏрЃБрЃерЃљрЃЮрЃА рЃерЃћрЃЏрЃЮрЃЏрЃљрЃЋрЃљрЃџрЃў рЃбрЃћрЃЦрЃАрЃбрЃБрЃарЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃў, рЃЊрЃљрЃљрЃюрЃљрЃгрЃўрЃџрЃЮрЃА рЃўрЃАрЃўрЃюрЃў рЃљрЃарЃњрЃБрЃЏрЃћрЃюрЃбрЃћрЃЉрЃљрЃЊ (`argc`, `argv` рЃАрЃбрЃўрЃџрЃерЃў) рЃЊрЃљ рЃњрЃљрЃЏрЃЮрЃўрЃФрЃљрЃ«рЃЮрЃА рЃАрЃгрЃЮрЃарЃў `callback` рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ.
- **­ЪЊА рЃЏрЃарЃљрЃЋрЃљрЃџрЃљрЃарЃ«рЃўрЃљрЃюрЃЮрЃЉрЃљ (Multi-Source Input):** рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃерЃћрЃЦрЃЏрЃюрЃўрЃџрЃўрЃљ рЃўрЃАрЃћ, рЃарЃЮрЃЏ рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃўрЃдрЃћрЃЉрЃЊрЃћрЃА рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃА рЃарЃљрЃЏрЃЊрЃћрЃюрЃўрЃЏрЃћ рЃгрЃДрЃљрЃарЃЮрЃЊрЃљрЃю:
    1. **­Ъњ╗ Serial Console (CLI):** рЃўрЃюрЃбрЃћрЃарЃљрЃЦрЃбрЃўрЃБрЃџрЃў, рЃљрЃЊрЃљрЃЏрЃўрЃљрЃюрЃўрЃАрЃЌрЃЋрЃўрЃА рЃњрЃљрЃАрЃљрЃњрЃћрЃЉрЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃўрЃА рЃ«рЃљрЃќрЃў, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃўрЃЊрЃћрЃљрЃџрЃБрЃарЃўрЃљ рЃњрЃљрЃЏрЃљрЃарЃЌрЃЋрЃўрЃАрЃљ рЃЊрЃљ рЃърЃўрЃарЃЊрЃљрЃърЃўрЃарЃў рЃЎрЃЮрЃюрЃбрЃарЃЮрЃџрЃўрЃАрЃЌрЃЋрЃўрЃА. рЃўрЃА рЃўрЃюрЃбрЃћрЃњрЃарЃўрЃарЃћрЃЉрЃБрЃџрЃўрЃљ рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃџрЃЮрЃњрЃўрЃарЃћрЃЉрЃљрЃАрЃЌрЃљрЃю рЃЊрЃљ рЃљрЃа рЃўрЃгрЃЋрЃћрЃЋрЃА рЃЎрЃЮрЃюрЃцрЃџрЃўрЃЦрЃбрЃћрЃЉрЃА.
    2. **­ЪЊе Event Bus:** рЃњрЃљрЃЏрЃЮрЃўрЃгрЃћрЃарЃА `SYNAPSE_EVENT_EXECUTE_COMMAND_STRING` рЃўрЃЋрЃћрЃюрЃЌрЃА, рЃарЃљрЃф рЃАрЃљрЃерЃБрЃљрЃџрЃћрЃЉрЃљрЃА рЃљрЃФрЃџрЃћрЃЋрЃА рЃАрЃ«рЃЋрЃљ рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃА (рЃЏрЃљрЃњ., `mqtt_client`), рЃърЃарЃЮрЃњрЃарЃљрЃЏрЃБрЃџрЃљрЃЊ рЃњрЃљрЃБрЃерЃЋрЃљрЃю рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃў.
- **­ЪЊќ рЃЕрЃљрЃерЃћрЃюрЃћрЃЉрЃБрЃџрЃў рЃЊрЃљрЃ«рЃЏрЃљрЃарЃћрЃЉрЃўрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃљ:** `help` рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃљрЃЕрЃЋрЃћрЃюрЃћрЃЉрЃА рЃДрЃЋрЃћрЃџрЃљ рЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃБрЃџ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљрЃА, рЃЏрЃљрЃЌ рЃљрЃдрЃгрЃћрЃарЃљрЃА рЃЊрЃљ рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃА рЃцрЃЮрЃарЃЏрЃљрЃбрЃА.

## 3. ­ЪЏа№ИЈ рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ

рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ рЃ«рЃЊрЃћрЃЉрЃљ `Kconfig` (`idf.py menuconfig`) рЃЊрЃљ `system_config.json` рЃцрЃљрЃўрЃџрЃћрЃЉрЃўрЃА рЃАрЃљрЃерЃБрЃљрЃџрЃћрЃЉрЃўрЃЌ.

- **­ЪЊЮ рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў (`system_config.json`):**

    ```json
    {
      "type": "command_router",
      "enabled": true,
      "config": {
        "instance_name": "main_cmd_router",
        "enable_serial_shell": true,
        "serial_shell_prompt": "SYNAPSE> "
      }
    }
    ```

- **РџЎ№ИЈ рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃћрЃЉрЃў:**

| рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃў              | рЃбрЃўрЃърЃў    | рЃљрЃдрЃгрЃћрЃарЃљ                                                       | рЃАрЃљрЃЋрЃљрЃџрЃЊрЃћрЃЉрЃБрЃџрЃЮ | Default (`Kconfig`) |
| :---------------------- | :------ | :----------------------------------------------------------- | :----------: | :------------------ |
| `instance_name`         | рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў | рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃўрЃюрЃАрЃбрЃљрЃюрЃфрЃўрЃўрЃА рЃБрЃюрЃўрЃЎрЃљрЃџрЃБрЃарЃў рЃАрЃљрЃ«рЃћрЃџрЃў.                         |      РЮї      | `main_cmd_router`   |
| `enable_serial_shell`   | boolean | рЃарЃЌрЃљрЃЋрЃА/рЃЌрЃўрЃерЃљрЃЋрЃА рЃўрЃюрЃбрЃћрЃарЃљрЃЦрЃбрЃўрЃБрЃџ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃўрЃА рЃ«рЃљрЃќрЃА рЃАрЃћрЃарЃўрЃБрЃџ рЃърЃЮрЃарЃбрЃќрЃћ.      |      РЮї      | `true`              |
| `serial_shell_prompt`   | рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў | рЃАрЃћрЃарЃўрЃБрЃџрЃў рЃЎрЃЮрЃюрЃАрЃЮрЃџрЃўрЃА prompt-рЃўрЃА рЃбрЃћрЃЦрЃАрЃбрЃў.                           |      РЮї      | `"SYNAPSE> "`       |

## 4. ­Ъћї Service API (`cmd_router_api_t`)

рЃАрЃ«рЃЋрЃљ рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃА рЃерЃћрЃБрЃФрЃџрЃўрЃљрЃЌ рЃЊрЃљрЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃЮрЃю рЃЌрЃљрЃЋрЃўрЃљрЃюрЃЌрЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃў `Service Locator`-рЃўрЃА рЃЏрЃћрЃерЃЋрЃћрЃЮрЃЉрЃўрЃЌ. рЃАрЃћрЃарЃЋрЃўрЃАрЃўрЃА рЃбрЃўрЃърЃў: **`SYNAPSE_SERVICE_TYPE_CMD_ROUTER_API`**. рЃўрЃюрЃбрЃћрЃарЃцрЃћрЃўрЃАрЃў рЃљрЃдрЃгрЃћрЃарЃўрЃџрЃўрЃљ `components/interfaces/include/cmd_router_interface.h`-рЃерЃў.

- **API рЃцрЃБрЃюрЃЦрЃфрЃўрЃћрЃЉрЃў:**
  - `esp_err_t register_command(const cmd_t *command);`
    - рЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃА рЃљрЃ«рЃљрЃџ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљрЃА.
  - `esp_err_t unregister_command(const char *command_name);`
    - рЃљрЃБрЃЦрЃЏрЃћрЃЉрЃА рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃарЃћрЃњрЃўрЃАрЃбрЃарЃљрЃфрЃўрЃљрЃА. **рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃџрЃљрЃЊ рЃБрЃюрЃЊрЃљ рЃњрЃљрЃЏрЃЮрЃўрЃФрЃљрЃ«рЃЮрЃА рЃЏрЃЮрЃЊрЃБрЃџрЃЏрЃљ рЃЌрЃљрЃЋрЃўрЃА `deinit` рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃерЃў.**

- **`cmd_t` рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ:**

    ```c
    typedef struct {
        const char *command;      // рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў, рЃЏрЃљрЃњ., "relay"
        const char *help;         // рЃЊрЃљрЃ«рЃЏрЃљрЃарЃћрЃЉрЃўрЃА рЃбрЃћрЃЦрЃАрЃбрЃў, рЃЏрЃљрЃњ., "Controls a relay actuator."
        const char *usage;        // рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃА рЃцрЃЮрЃарЃЏрЃљрЃбрЃў, рЃЏрЃљрЃњ., "relay <name> <on|off>"
        int min_args;             // рЃљрЃарЃњрЃБрЃЏрЃћрЃюрЃбрЃћрЃЉрЃўрЃА рЃЏрЃўрЃюрЃўрЃЏрЃљрЃџрЃБрЃарЃў рЃарЃљрЃЮрЃЊрЃћрЃюрЃЮрЃЉрЃљ (рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃЕрЃљрЃЌрЃЋрЃџрЃўрЃЌ)
        int max_args;             // рЃљрЃарЃњрЃБрЃЏрЃћрЃюрЃбрЃћрЃЉрЃўрЃА рЃЏрЃљрЃЦрЃАрЃўрЃЏрЃљрЃџрЃБрЃарЃў рЃарЃљрЃЮрЃЊрЃћрЃюрЃЮрЃЉрЃљ (рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃЕрЃљрЃЌрЃЋрЃџрЃўрЃЌ)
        esp_err_t (*handler)(int argc, char **argv, void *context);
        void *context;            // рЃЎрЃЮрЃюрЃбрЃћрЃЦрЃАрЃбрЃў, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃњрЃљрЃЊрЃљрЃћрЃфрЃћрЃЏрЃљ handler-рЃА (рЃ«рЃерЃўрЃарЃљрЃЊ, module_t* self)
    } cmd_t;
    ```

## 5. ­Ъџђ рЃЕрЃљрЃерЃћрЃюрЃћрЃЉрЃБрЃџрЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃў

рЃЏрЃЮрЃЊрЃБрЃџрЃА рЃЏрЃЮрЃДрЃЋрЃћрЃЉрЃљ рЃарЃљрЃЏрЃЊрЃћрЃюрЃўрЃЏрЃћ рЃЕрЃљрЃерЃћрЃюрЃћрЃЉрЃБрЃџрЃў, рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃарЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ:

- **`help`**: рЃљрЃЕрЃЋрЃћрЃюрЃћрЃЉрЃА рЃДрЃЋрЃћрЃџрЃљ рЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃБрЃџ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљрЃА.
- **`modules [--info <instance_name>]`**:
  - рЃљрЃарЃњрЃБрЃЏрЃћрЃюрЃбрЃћрЃЉрЃўрЃА рЃњрЃљрЃарЃћрЃерЃћ, рЃЉрЃћрЃГрЃЊрЃљрЃЋрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃљрЃерЃў рЃљрЃарЃАрЃћрЃЉрЃБрЃџрЃў рЃДрЃЋрЃћрЃџрЃљ рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃАрЃўрЃљрЃА рЃЊрЃљ рЃЏрЃљрЃЌ рЃАрЃбрЃљрЃбрЃБрЃАрЃА.
  - `--info` рЃљрЃарЃњрЃБрЃЏрЃћрЃюрЃбрЃўрЃЌ, рЃЉрЃћрЃГрЃЊрЃљрЃЋрЃА рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃЊрЃћрЃбрЃљрЃџрЃБрЃа, рЃЊрЃўрЃљрЃњрЃюрЃЮрЃАрЃбрЃўрЃЎрЃБрЃа рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљрЃА (рЃЌрЃБ рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃЏ рЃцрЃБрЃюрЃЦрЃфрЃўрЃЮрЃюрЃљрЃџрЃА рЃБрЃГрЃћрЃарЃА рЃЏрЃ«рЃљрЃарЃА).
- **`reboot`**: рЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃА рЃЏрЃЮрЃгрЃДрЃЮрЃЉрЃўрЃџрЃЮрЃЉрЃўрЃА рЃърЃарЃЮрЃњрЃарЃљрЃЏрЃБрЃџ рЃњрЃљрЃЊрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃљрЃА.

## 6. ­ЪњА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў

рЃгрЃљрЃарЃЏрЃЮрЃЋрЃўрЃЊрЃњрЃўрЃюрЃЮрЃЌ, `relay_module` рЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃА рЃЌрЃљрЃЋрЃўрЃА рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљрЃА.

- **1. рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃарЃћрЃњрЃўрЃАрЃбрЃарЃљрЃфрЃўрЃљ (`relay_module.c`-рЃерЃў):**

    ```c
    // relay_module_init рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃерЃў
    
    // 1. рЃЋрЃЦрЃЏрЃюрЃўрЃЌ handler рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃА
    static esp_err_t relay_cmd_handler(int argc, char **argv, void *context) {
        module_t *relay_module_instance = (module_t*)context;
        
        if (argc != 3) {
            printf("Error: Invalid arguments.\nUsage: relay <instance_name> <on|off|toggle>\n");
            return ESP_ERR_INVALID_ARG;
        }
        
        const char* target_instance = argv[1];
        const char* action = argv[2];

        // ... рЃўрЃърЃЮрЃЋрЃћрЃЌ рЃарЃћрЃџрЃћрЃА API Service Locator-рЃўрЃЌ target_instance-рЃўрЃА рЃЏрЃўрЃ«рЃћрЃЊрЃЋрЃўрЃЌ ...
        // ... рЃЊрЃљ рЃњрЃљрЃЏрЃЮрЃўрЃФрЃљрЃ«рЃћрЃЌ рЃерЃћрЃАрЃљрЃЉрЃљрЃЏрЃўрЃАрЃў рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃљ (set_state, toggle) ...
        
        printf("Relay '%s' action '%s' executed.\n", target_instance, action);
        return ESP_OK;
    }
    
    // 2. рЃЋрЃљрЃЏрЃќрЃљрЃЊрЃћрЃЉрЃЌ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃљрЃдрЃгрЃћрЃарЃљрЃА
    // рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃўрЃљ: рЃћрЃА рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА static, рЃарЃљрЃЌрЃљ рЃЏрЃўрЃАрЃў рЃЏрЃўрЃАрЃљрЃЏрЃљрЃарЃЌрЃў рЃЋрЃљрЃџрЃўрЃЊрЃБрЃарЃў рЃЊрЃљрЃарЃЕрЃћрЃА
    static cmd_t relay_command;
    relay_command = (cmd_t){
        .command = "relay",
        .help = "Controls a relay actuator.",
        .usage = "relay <instance_name> <on|off|toggle>",
        .min_args = 3,
        .max_args = 3,
        .handler = relay_cmd_handler,
        .context = self // рЃњрЃљрЃЊрЃљрЃЋрЃћрЃфрЃўрЃЌ module_t* self, рЃарЃЮрЃњрЃЮрЃарЃф рЃЎрЃЮрЃюрЃбрЃћрЃЦрЃАрЃбрЃў
    };
    
    // 3. рЃЋрЃўрЃдрЃћрЃЉрЃЌ Command Router-рЃўрЃА API-рЃА рЃЊрЃљ рЃЋрЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃЌ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљрЃА
    service_handle_t handle = synapse_service_get("main_cmd_router");
    if (handle) {
        cmd_router_api_t *cmd_api = (cmd_router_api_t *)handle;
        cmd_api->register_command(&relay_command);
    }
    
    // 4. рЃљрЃа рЃЊрЃљрЃњрЃљрЃЋрЃўрЃгрЃДрЃЊрЃћрЃЌ рЃЊрЃћрЃарЃћрЃњрЃўрЃАрЃбрЃарЃљрЃфрЃўрЃљ relay_module_deinit рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃерЃў:
    // if (handle) {
    //     cmd_router_api_t *cmd_api = (cmd_router_api_t *)handle;
    //     cmd_api->unregister_command("relay");
    // }
    ```

- **2. рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃерЃћрЃАрЃарЃБрЃџрЃћрЃЉрЃљ:**
  - **­Ъњ╗ рЃАрЃћрЃарЃўрЃБрЃџрЃў рЃърЃЮрЃарЃбрЃўрЃЊрЃљрЃю:**

      ```bash
      SYNAPSE> relay main_light on
      ```

  - **РўЂ№ИЈ MQTT-рЃЊрЃљрЃю (рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў):**

      ```c
      // mqtt_client.c-рЃерЃў
      
      // рЃЋрЃЦрЃЏрЃюрЃўрЃЌ payload-рЃА Command Router-рЃўрЃАрЃЌрЃЋрЃўрЃА
      synapse_command_payload_t* payload = malloc(sizeof(synapse_command_payload_t));
      strncpy(payload->command_string, "relay main_light on", sizeof(payload->command_string) - 1);
      strncpy(payload->source, "mqtt", sizeof(payload->source) - 1);
      
      // рЃЋрЃљрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃЌ рЃўрЃЋрЃћрЃюрЃЌрЃА
      event_data_wrapper_t *wrapper;
      synapse_event_data_wrap(payload, free, &wrapper); // рЃЋрЃўрЃДрЃћрЃюрЃћрЃЉрЃЌ рЃАрЃбрЃљрЃюрЃЊрЃљрЃарЃбрЃБрЃџ free-рЃА
      synapse_event_bus_post(SYNAPSE_EVENT_EXECUTE_COMMAND_STRING, wrapper);
      synapse_event_data_release(wrapper);
      ```

## 7. ­ЪЕ║ рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃћрЃЉрЃўрЃА рЃЏрЃЮрЃњрЃЋрЃљрЃарЃћрЃЉрЃљ (Troubleshooting)

- **рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ:** рЃЎрЃЮрЃюрЃАрЃЮрЃџрЃерЃў рЃўрЃЉрЃћрЃГрЃЊрЃћрЃЉрЃљ "рЃюрЃљрЃњрЃљрЃЋрЃў" рЃљрЃю `ESP_ERR_NO_MEM` рЃерЃћрЃфрЃЊрЃЮрЃЏрЃћрЃЉрЃў.
  - **рЃЏрЃўрЃќрЃћрЃќрЃў:** UART рЃърЃЮрЃарЃбрЃўрЃА рЃЎрЃЮрЃюрЃцрЃџрЃўрЃЦрЃбрЃў рЃџрЃЮрЃњрЃўрЃарЃћрЃЉрЃљрЃАрЃљ рЃЊрЃљ рЃЎрЃЮрЃюрЃАрЃЮрЃџрЃА рЃерЃЮрЃарЃўрЃА.
  - **рЃњрЃљрЃЊрЃљрЃгрЃДрЃЋрЃћрЃбрЃљ:** рЃЊрЃљрЃарЃгрЃЏрЃБрЃюрЃЊрЃўрЃЌ, рЃарЃЮрЃЏ `command_router.c`-рЃерЃў `serial_shell_task` рЃўрЃДрЃћрЃюрЃћрЃЉрЃА `esp_console_init` рЃЊрЃљ `esp_console_run` рЃцрЃБрЃюрЃЦрЃфрЃўрЃћрЃЉрЃА, рЃарЃЮрЃњрЃЮрЃарЃф рЃћрЃА рЃАрЃљрЃЉрЃЮрЃџрЃЮрЃЮ рЃЋрЃћрЃарЃАрЃўрЃљрЃерЃўрЃљ. рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЌ Baud Rate-рЃўрЃА рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃћрЃЉрЃў `menuconfig`-рЃерЃў рЃЊрЃљ рЃЌрЃЦрЃЋрЃћрЃюрЃА рЃАрЃћрЃарЃўрЃБрЃџ рЃЏрЃЮрЃюрЃўрЃбрЃЮрЃарЃерЃў.
- **рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ:** рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ рЃљрЃа рЃАрЃарЃБрЃџрЃЊрЃћрЃЉрЃљ, `Command not found`.
  - **рЃЏрЃўрЃќрЃћрЃќрЃў:** рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ рЃљрЃа рЃљрЃарЃўрЃА рЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃБрЃџрЃў, рЃљрЃю рЃарЃћрЃњрЃўрЃАрЃбрЃарЃљрЃфрЃўрЃљ рЃЋрЃћрЃа рЃЏрЃЮрЃ«рЃћрЃарЃ«рЃЊрЃљ.
  - **рЃњрЃљрЃЊрЃљрЃгрЃДрЃЋрЃћрЃбрЃљ:** рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЌ рЃџрЃЮрЃњрЃћрЃЉрЃў `CMD_ROUTER: Command registered: '...'` рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃљрЃќрЃћ. рЃЊрЃљрЃарЃгрЃЏрЃБрЃюрЃЊрЃўрЃЌ, рЃарЃЮрЃЏ `synapse_service_get` рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃљрЃЉрЃарЃБрЃюрЃћрЃЉрЃА `cmd_router`-рЃўрЃА API-рЃА.
