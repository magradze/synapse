# Synapse Command Router API Reference

## ­Ъј» рЃЏрЃўрЃќрЃљрЃюрЃў

рЃћрЃА рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃў рЃљрЃдрЃгрЃћрЃарЃА `Command Router` рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃАрЃљрЃ»рЃљрЃарЃЮ Service API-рЃА, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃ«рЃћрЃџрЃЏрЃўрЃАрЃљрЃгрЃЋрЃЊрЃЮрЃЏрЃўрЃљ рЃАрЃ«рЃЋрЃљ рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА `Service Locator`-рЃўрЃА рЃЏрЃћрЃерЃЋрЃћрЃЮрЃЉрЃўрЃЌ. рЃћрЃА API рЃАрЃљрЃерЃБрЃљрЃџрЃћрЃЉрЃљрЃА рЃљрЃФрЃџрЃћрЃЋрЃА рЃюрЃћрЃЉрЃўрЃАрЃЏрЃўрЃћрЃа рЃЏрЃЮрЃЊрЃБрЃџрЃА, рЃЊрЃљрЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃЮрЃА рЃЊрЃљ рЃЏрЃљрЃарЃЌрЃЮрЃА рЃАрЃљрЃЎрЃБрЃЌрЃљрЃарЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃў рЃфрЃћрЃюрЃбрЃарЃљрЃџрЃўрЃќрЃћрЃЉрЃБрЃџрЃљрЃЊ.

**рЃАрЃћрЃарЃЋрЃўрЃАрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў:** `main_cmd_router` (рЃљрЃю рЃарЃЮрЃњрЃЮрЃарЃф рЃЏрЃўрЃЌрЃўрЃЌрЃћрЃЉрЃБрЃџрЃўрЃљ `system_config.json`-рЃерЃў)  
**рЃАрЃћрЃарЃЋрЃўрЃАрЃўрЃА рЃбрЃўрЃърЃў:** `FMW_SERVICE_TYPE_CMD_ROUTER_API`  
**рЃўрЃюрЃбрЃћрЃарЃцрЃћрЃўрЃАрЃўрЃА рЃ░рЃћрЃЊрЃћрЃарЃў:** `cmd_router_interface.h`

---

## РџЎ№ИЈ API рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ (`cmd_router_api_t`)

рЃћрЃА рЃљрЃарЃўрЃА рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃерЃћрЃўрЃфрЃљрЃЋрЃА рЃцрЃБрЃюрЃЦрЃфрЃўрЃўрЃА рЃЏрЃљрЃЕрЃЋрЃћрЃюрЃћрЃЉрЃџрЃћрЃЉрЃА `Command Router`-рЃўрЃА рЃАрЃљрЃЏрЃљрЃарЃЌрЃљрЃЋрЃљрЃЊ.

```c
typedef struct
{
    esp_err_t (*register_command)(const cmd_t *command);
    esp_err_t (*unregister_command)(const char *command_name);
} cmd_router_api_t;
```

---

## ­ЪЊџ API рЃцрЃБрЃюрЃЦрЃфрЃўрЃћрЃЉрЃў

### esp_err_t register_command(const cmd_t *command)

рЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃА рЃљрЃ«рЃљрЃџ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА `Command Router`-рЃерЃў. рЃарЃћрЃњрЃўрЃАрЃбрЃарЃљрЃфрЃўрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ, рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ рЃ«рЃћрЃџрЃЏрЃўрЃАрЃљрЃгрЃЋрЃЊрЃЮрЃЏрЃў рЃ«рЃЊрЃћрЃЉрЃљ рЃДрЃЋрЃћрЃџрЃљ рЃгрЃДрЃљрЃарЃЮрЃЊрЃљрЃю (Serial, Event Bus рЃЊрЃљ рЃљ.рЃе.).

- **@param[in] `command`**: рЃЏрЃљрЃЕрЃЋрЃћрЃюрЃћрЃЉрЃћрЃџрЃў `const cmd_t` рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљрЃќрЃћ, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃАрЃарЃБрЃџрЃљрЃЊ рЃљрЃдрЃгрЃћрЃарЃА рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљрЃА.
  - **рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃўрЃљ:** рЃљрЃЏ рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃўрЃАрЃЌрЃЋрЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃЮрЃцрЃўрЃџрЃў рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃљ рЃБрЃюрЃЊрЃљ рЃЊрЃљрЃарЃЕрЃћрЃА рЃЋрЃљрЃџрЃўрЃЊрЃБрЃарЃў рЃЏрЃЌрЃћрЃџрЃў рЃърЃарЃЮрЃњрЃарЃљрЃЏрЃўрЃА рЃЏрЃБрЃерЃљрЃЮрЃЉрЃўрЃА рЃњрЃљрЃюрЃЏрЃљрЃЋрЃџрЃЮрЃЉрЃљрЃерЃў. рЃарЃћрЃЎрЃЮрЃЏрЃћрЃюрЃЊрЃћрЃЉрЃБрЃџрЃўрЃљ рЃЏрЃўрЃАрЃў `static` рЃфрЃЋрЃџрЃљрЃЊрЃљрЃЊ рЃњрЃљрЃЏрЃЮрЃфрЃ«рЃљрЃЊрЃћрЃЉрЃљ.

- **@return**
  - `ESP_OK`: рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃЊрЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃЊрЃљ.
  - `ESP_ERR_INVALID_ARG`: рЃЌрЃБ `command` рЃЏрЃљрЃЕрЃЋрЃћрЃюрЃћрЃЉрЃћрЃџрЃў рЃљрЃю рЃЏрЃўрЃАрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃў рЃЋрЃћрЃџрЃћрЃЉрЃў (`command`, `handler`) рЃљрЃарЃўрЃА `NULL`.
  - `ESP_ERR_NO_MEM`: рЃЌрЃБ рЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃБрЃџрЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃўрЃА рЃАрЃўрЃљ рЃАрЃљрЃЋрЃАрЃћрЃљ (`CONFIG_COMMAND_ROUTER_MAX_COMMANDS`).
  - `ESP_ERR_INVALID_STATE`: рЃЌрЃБ рЃљрЃЏ рЃАрЃљрЃ«рЃћрЃџрЃўрЃА рЃЏрЃЦрЃЮрЃюрЃћ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ рЃБрЃЎрЃЋрЃћ рЃљрЃарЃАрЃћрЃЉрЃЮрЃЉрЃА.

---

### esp_err_t unregister_command(const char *command_name)

рЃерЃџрЃўрЃА (рЃљрЃБрЃЦрЃЏрЃћрЃЉрЃА рЃарЃћрЃњрЃўрЃАрЃбрЃарЃљрЃфрЃўрЃљрЃА) рЃљрЃЊрЃарЃћ рЃЊрЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃБрЃџ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљрЃА.

- **@param[in] `command_name`**: рЃўрЃЏ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў (рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў), рЃарЃЮрЃЏрЃџрЃўрЃА рЃарЃћрЃњрЃўрЃАрЃбрЃарЃљрЃфрЃўрЃљрЃф рЃБрЃюрЃЊрЃљ рЃњрЃљрЃБрЃЦрЃЏрЃЊрЃћрЃА.

- **@return**
  - `ESP_OK`: рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃгрЃљрЃўрЃерЃљрЃџрЃљ.
  - `ESP_ERR_NOT_FOUND`: рЃЌрЃБ рЃЏрЃўрЃЌрЃўрЃЌрЃћрЃЉрЃБрЃџрЃў рЃАрЃљрЃ«рЃћрЃџрЃўрЃА рЃЏрЃЦрЃЮрЃюрЃћ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ рЃЋрЃћрЃа рЃЏрЃЮрЃўрЃФрЃћрЃЉрЃюрЃљ.
  - `ESP_ERR_INVALID_ARG`: рЃЌрЃБ `command_name` рЃљрЃарЃўрЃА `NULL`.

**@note** рЃћрЃА рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃџрЃљрЃЊ рЃБрЃюрЃЊрЃљ рЃњрЃљрЃЏрЃЮрЃўрЃФрЃљрЃ«рЃЮрЃА рЃЏрЃЮрЃЊрЃБрЃџрЃЏрЃљ рЃЌрЃљрЃЋрЃўрЃА `deinit` рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃерЃў, рЃарЃљрЃЌрЃљ рЃАрЃўрЃАрЃбрЃћрЃЏрЃљрЃерЃў рЃљрЃа рЃЊрЃљрЃарЃЕрЃћрЃА "рЃЏрЃЮрЃЕрЃЋрЃћрЃюрЃћрЃЉрЃљ" рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃў.

---

## ­ЪЊќ рЃЊрЃљрЃЏрЃ«рЃЏрЃљрЃарЃћ рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ (`cmd_t`)

рЃћрЃА рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћрЃЉрЃљ `register_command` рЃцрЃБрЃюрЃЦрЃфрЃўрЃўрЃАрЃЌрЃЋрЃўрЃА рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃАрЃарЃБрЃџрЃљрЃЊ рЃљрЃдрЃАрЃљрЃгрЃћрЃарЃљрЃЊ.

```c
typedef struct {
    const char *command;      // рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў, рЃЏрЃљрЃњ., "relay"
    const char *help;         // рЃЊрЃљрЃ«рЃЏрЃљрЃарЃћрЃЉрЃўрЃА рЃбрЃћрЃЦрЃАрЃбрЃў, рЃЏрЃљрЃњ., "Controls a relay actuator."
    const char *usage;        // рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃА рЃцрЃЮрЃарЃЏрЃљрЃбрЃў, рЃЏрЃљрЃњ., "relay <name> <on|off>"
    int min_args;             // рЃљрЃарЃњрЃБрЃЏрЃћрЃюрЃбрЃћрЃЉрЃўрЃА рЃЏрЃўрЃюрЃўрЃЏрЃљрЃџрЃБрЃарЃў рЃарЃљрЃЮрЃЊрЃћрЃюрЃЮрЃЉрЃљ (рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃЕрЃљрЃЌрЃЋрЃџрЃўрЃЌ)
    int max_args;             // рЃљрЃарЃњрЃБрЃЏрЃћрЃюрЃбрЃћрЃЉрЃўрЃА рЃЏрЃљрЃЦрЃАрЃўрЃЏрЃљрЃџрЃБрЃарЃў рЃарЃљрЃЮрЃЊрЃћрЃюрЃЮрЃЉрЃљ (рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃЕрЃљрЃЌрЃЋрЃџрЃўрЃЌ)
    
    // рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃЊрЃљрЃЏрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃћрЃџрЃў callback рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ
    esp_err_t (*handler)(int argc, char **argv, void *context);
    
    // рЃЎрЃЮрЃюрЃбрЃћрЃЦрЃАрЃбрЃў, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃњрЃљрЃЊрЃљрЃћрЃфрЃћрЃЏрЃљ handler-рЃА (рЃ«рЃерЃўрЃарЃљрЃЊ, module_t* self)
    void *context;            
} cmd_t;
```

---

## ­ЪњА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў

`relay_module`-рЃўрЃА `init` рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃерЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃарЃћрЃњрЃўрЃАрЃбрЃарЃљрЃфрЃўрЃљ:

```c
// In relay_module.c

// 1. Handler-рЃўрЃА рЃерЃћрЃЦрЃЏрЃюрЃљ
static esp_err_t relay_cmd_handler(int argc, char **argv, void *context) {
    // ... handler-рЃўрЃА рЃџрЃЮрЃњрЃўрЃЎрЃљ ...
    return ESP_OK;
}

// 2. init рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃерЃў рЃарЃћрЃњрЃўрЃАрЃбрЃарЃљрЃфрЃўрЃљ
static esp_err_t relay_module_init(module_t *self) {
    // ...
    
    // рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃўрЃА рЃЏрЃЮрЃЏрЃќрЃљрЃЊрЃћрЃЉрЃљ
    static cmd_t relay_command;
    relay_command = (cmd_t){
        .command = "relay",
        .help = "Controls a relay actuator.",
        .usage = "relay <instance_name> <on|off>",
        .min_args = 3,
        .max_args = 3,
        .handler = relay_cmd_handler,
        .context = self // рЃњрЃљрЃЊрЃљрЃЋрЃћрЃфрЃўрЃЌ module_t* self, рЃарЃЮрЃњрЃЮрЃарЃф рЃЎрЃЮрЃюрЃбрЃћрЃЦрЃАрЃбрЃў
    };

    // Command Router рЃАрЃћрЃарЃЋрЃўрЃАрЃўрЃА рЃЏрЃЮрЃФрЃўрЃћрЃЉрЃљ рЃЊрЃљ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃарЃћрЃњрЃўрЃАрЃбрЃарЃљрЃфрЃўрЃљ
    service_handle_t handle = fmw_service_get("main_cmd_router");
    if (handle) {
        cmd_router_api_t *cmd_api = (cmd_router_api_t *)handle;
        esp_err_t err = cmd_api->register_command(&relay_command);
        if (err != ESP_OK) {
            ESP_LOGE(TAG, "Failed to register 'relay' command: %s", esp_err_to_name(err));
        }
    } else {
        ESP_LOGW(TAG, "Command Router service not found. Cannot register commands.");
    }

    // ...
    return ESP_OK;
}
```
