# рЃЏрЃЮрЃЊрЃБрЃџрЃў: OTA Update Manager

## 1. рЃЏрЃўрЃЏрЃЮрЃ«рЃўрЃџрЃЋрЃљ

**рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў:** `ota_update_manager`  
**рЃЎрЃљрЃбрЃћрЃњрЃЮрЃарЃўрЃљ:** `system`  
**рЃЋрЃћрЃарЃАрЃўрЃљ:** 1.0.0  
**рЃљрЃЋрЃбрЃЮрЃарЃў:** Synapse Framework Team

`OTA Update Manager` рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃБрЃќрЃарЃБрЃюрЃЋрЃћрЃџрЃДрЃЮрЃцрЃА Synapse Framework-рЃўрЃАрЃЌрЃЋрЃўрЃА рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮ рЃЊрЃљ рЃАрЃљрЃўрЃЏрЃћрЃЊрЃЮ Over-the-Air (OTA) firmware рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃЏрЃћрЃЦрЃљрЃюрЃўрЃќрЃЏрЃА. рЃўрЃА рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃА рЃарЃЮрЃњрЃЮрЃарЃф рЃЏрЃљрЃдрЃљрЃџрЃў рЃЊрЃЮрЃюрЃўрЃА "рЃЏрЃћрЃюрЃћрЃ»рЃћрЃарЃў", рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃЎрЃЮрЃЮрЃарЃЊрЃўрЃюрЃљрЃфрЃўрЃљрЃА рЃБрЃгрЃћрЃЋрЃА рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃърЃарЃЮрЃфрЃћрЃАрЃўрЃА рЃДрЃЋрЃћрЃџрЃљ рЃћрЃбрЃљрЃърЃА: рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃарЃћрЃАрЃБрЃарЃАрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљрЃА, firmware-рЃўрЃА рЃњрЃљрЃЊрЃЏрЃЮрЃгрЃћрЃарЃљрЃА, рЃЋрЃљрЃџрЃўрЃЊрЃљрЃфрЃўрЃљрЃА рЃЊрЃљ рЃЏрЃЮрЃгрЃДрЃЮрЃЉрЃўрЃџрЃЮрЃЉрЃўрЃА рЃњрЃљрЃЊрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃљрЃА.

рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃерЃћрЃЦрЃЏрЃюрЃўрЃџрЃўрЃљ рЃцрЃарЃћрЃўрЃЏрЃЋрЃЮрЃарЃЦрЃўрЃА рЃФрЃўрЃарЃўрЃЌрЃљрЃЊрЃў рЃърЃарЃўрЃюрЃфрЃўрЃърЃћрЃЉрЃўрЃА рЃАрЃарЃБрЃџрЃў рЃЊрЃљрЃфрЃЋрЃўрЃЌ, рЃарЃљрЃф рЃБрЃќрЃарЃБрЃюрЃЋрЃћрЃџрЃДрЃЮрЃцрЃА рЃЏрЃўрЃА рЃўрЃќрЃЮрЃџрЃўрЃарЃћрЃЉрЃБрЃџ рЃЊрЃљ рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃќрЃћ рЃЊрЃљрЃцрЃБрЃФрЃюрЃћрЃЉрЃБрЃџ рЃЏрЃБрЃерЃљрЃЮрЃЉрЃљрЃА.

## 2. рЃгрЃўрЃюрЃљрЃърЃўрЃарЃЮрЃЉрЃћрЃЉрЃў рЃЊрЃљ `menuconfig`

рЃљрЃЏ рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃњрЃљрЃЏрЃљрЃарЃЌрЃБрЃџрЃў рЃЏрЃБрЃерЃљрЃЮрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ ESP-IDF-рЃўрЃА рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљрЃерЃў (`menuconfig`) рЃерЃћрЃЏрЃЊрЃћрЃњрЃў рЃЮрЃцрЃфрЃўрЃћрЃЉрЃўрЃА рЃЕрЃљрЃарЃЌрЃЋрЃљ:

1. **Bootloader-рЃўрЃА рЃЏрЃ«рЃљрЃарЃЊрЃљрЃГрЃћрЃарЃљ:**
    * рЃњрЃќрЃљ: `Component config` Рєњ `Bootloader`
    * рЃЮрЃцрЃфрЃўрЃљ: `[*] Allow app partition length to be shrunk to fit bootloader` (рЃЌрЃБ рЃАрЃљрЃГрЃўрЃарЃЮрЃљ)

2. **OTA рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ:**
    * рЃњрЃќрЃљ: `Component config` Рєњ `ESP HTTPS OTA`
    * рЃЮрЃцрЃфрЃўрЃљ: `[*] Allow HTTP redirection` (рЃарЃћрЃЎрЃЮрЃЏрЃћрЃюрЃЊрЃћрЃЉрЃБрЃџрЃўрЃљ)

3. **рЃАрЃћрЃарЃбрЃўрЃцрЃўрЃЎрЃљрЃбрЃћрЃЉрЃўрЃА рЃюрЃљрЃЎрЃарЃћрЃЉрЃў (Certificate Bundle):**
    * рЃњрЃќрЃљ: `Component config` Рєњ `mbedTLS`
    * рЃЮрЃцрЃфрЃўрЃљ: `[*] Add the certificate bundle to the firmware`
    * рЃћрЃА рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ HTTPS рЃЎрЃљрЃЋрЃерЃўрЃарЃўрЃАрЃЌрЃЋрЃўрЃА рЃЊрЃљ рЃАрЃћрЃарЃЋрЃћрЃарЃўрЃА рЃАрЃћрЃарЃбрЃўрЃцрЃўрЃЎрЃљрЃбрЃўрЃА рЃЋрЃљрЃџрЃўрЃЊрЃљрЃфрЃўрЃўрЃАрЃЌрЃЋрЃўрЃА.

4. **рЃ«рЃћрЃџрЃЏрЃЮрЃгрЃћрЃарЃўрЃА рЃЋрЃљрЃџрЃўрЃЊрЃљрЃфрЃўрЃљ (App Signing):**
    * рЃњрЃќрЃљ: `Security features`
    * рЃЮрЃцрЃфрЃўрЃљ: `[*] Enable hardware secure boot in DEVELOPMENT mode` рЃљрЃю `PRODUCTION mode`.
    * рЃЮрЃцрЃфрЃўрЃљ: `[*] Enable signature verification for secure boot`.
    * рЃћрЃА рЃБрЃќрЃарЃБрЃюрЃЋрЃћрЃџрЃДрЃЮрЃцрЃА, рЃарЃЮрЃЏ рЃЏрЃЮрЃгрЃДрЃЮрЃЉрЃўрЃџрЃЮрЃЉрЃљрЃЏ рЃњрЃљрЃБрЃерЃЋрЃљрЃА рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃАрЃљрЃюрЃЊрЃЮ, рЃфрЃўрЃцрЃарЃБрЃџрЃљрЃЊ рЃ«рЃћрЃџрЃЏрЃЮрЃгрЃћрЃарЃўрЃџрЃў firmware.

## 3. рЃљрЃарЃЦрЃўрЃбрЃћрЃЦрЃбрЃБрЃарЃБрЃџрЃў рЃърЃарЃўрЃюрЃфрЃўрЃърЃћрЃЉрЃў

* **Service-driven:** рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃгрЃЋрЃЊрЃўрЃА `ota_api_t` рЃАрЃћрЃарЃЋрЃўрЃАрЃА `Service Locator`-рЃўрЃА рЃЏрЃћрЃерЃЋрЃћрЃЮрЃЉрЃўрЃЌ, рЃарЃљрЃЌрЃљ рЃАрЃ«рЃЋрЃљ рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃЏрЃљ (рЃЏрЃљрЃњ., `mqtt_client`, `cmd_router`) рЃерЃћрЃФрЃџрЃЮрЃю рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃърЃарЃЮрЃфрЃћрЃАрЃўрЃА рЃўрЃюрЃўрЃфрЃўрЃарЃћрЃЉрЃљ.
* **Event-driven:** рЃърЃарЃЮрЃфрЃћрЃАрЃўрЃА рЃДрЃЋрЃћрЃџрЃљ рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃю рЃћрЃбрЃљрЃърЃќрЃћ (рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљ, рЃърЃарЃЮрЃњрЃарЃћрЃАрЃў, рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃљ, рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ) рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃА рЃерЃћрЃАрЃљрЃЉрЃљрЃЏрЃўрЃА рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃА `Event Bus`-рЃќрЃћ.
* **рЃўрЃюрЃбрЃћрЃњрЃарЃўрЃарЃћрЃЉрЃБрЃџрЃў рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮрЃћрЃЉрЃљ:** рЃўрЃДрЃћрЃюрЃћрЃЉрЃА HTTPS-рЃА, рЃАрЃћрЃарЃЋрЃћрЃарЃўрЃА рЃАрЃћрЃарЃбрЃўрЃцрЃўрЃЎрЃљрЃбрЃўрЃА рЃЋрЃљрЃџрЃўрЃЊрЃљрЃфрЃўрЃљрЃА рЃЊрЃљ рЃњрЃљрЃЊрЃЏрЃЮрЃгрЃћрЃарЃўрЃџрЃў firmware-рЃўрЃА рЃфрЃўрЃцрЃарЃБрЃџрЃў рЃ«рЃћрЃџрЃЏрЃЮрЃгрЃћрЃарЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљрЃА.
* **рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃЏрЃЊрЃњрЃарЃљрЃЊрЃЮрЃЉрЃљ:** рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљрЃЏрЃЊрЃћ, `Health Monitor` рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃЏрЃћрЃерЃЋрЃћрЃЮрЃЉрЃўрЃЌ рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃарЃћрЃАрЃБрЃарЃАрЃћрЃЉрЃА (рЃЏрЃљрЃњ., рЃЌрЃљрЃЋрЃўрЃАрЃБрЃцрЃљрЃџрЃў рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃљ), рЃарЃљрЃЌрЃљ рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃљрЃўрЃфрЃўрЃџрЃЮрЃА рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃърЃарЃЮрЃфрЃћрЃАрЃерЃў рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃњрЃљрЃГрЃћрЃЊрЃЋрЃљ.
* **рЃЋрЃўрЃќрЃБрЃљрЃџрЃБрЃарЃў рЃБрЃЎрЃБрЃЎрЃљрЃЋрЃерЃўрЃарЃў:** `RGB LED Indicator` рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃЌ, рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃћрЃџрЃА рЃљрЃгрЃЋрЃЊрЃўрЃА рЃЋрЃўрЃќрЃБрЃљрЃџрЃБрЃа рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљрЃА рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃерЃћрЃАрЃљрЃ«рЃћрЃЉ.

## 4. рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ

рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ рЃ«рЃЊрЃћрЃЉрЃљ `system_config.json` рЃцрЃљрЃўрЃџрЃўрЃА рЃАрЃљрЃерЃБрЃљрЃџрЃћрЃЉрЃўрЃЌ.

**рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў:**

```json
{
    "type": "ota_update_manager",
    "enabled": true,
    "config": {
        "instance_name": "main_ota_manager",
        "server_cert_pem_start": "-----BEGIN CERTIFICATE-----\n...",
        "pre_check_min_heap_kb": 80
    }
}
```

**рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃћрЃЉрЃў:**

| рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃў | рЃбрЃўрЃърЃў | рЃљрЃдрЃгрЃћрЃарЃљ | рЃАрЃљрЃЋрЃљрЃџрЃЊрЃћрЃЉрЃБрЃџрЃЮ | Default |
|:---|:---|:---|:---:|:---|
| `instance_name` | рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў | рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃўрЃюрЃАрЃбрЃљрЃюрЃфрЃўрЃўрЃА рЃБрЃюрЃўрЃЎрЃљрЃџрЃБрЃарЃў рЃАрЃљрЃ«рЃћрЃџрЃў. | РЮї | `ota_manager`|
| `server_cert_pem_start` | рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў | OTA рЃАрЃћрЃарЃЋрЃћрЃарЃўрЃА root CA рЃАрЃћрЃарЃбрЃўрЃцрЃўрЃЎрЃљрЃбрЃў PEM рЃцрЃЮрЃарЃЏрЃљрЃбрЃерЃў. | РЮї | ESP-IDF-рЃўрЃА default bundle |
| `pre_check_min_heap_kb` | рЃарЃўрЃфрЃ«рЃЋрЃў | рЃЌрЃљрЃЋрЃўрЃАрЃБрЃцрЃљрЃџрЃў рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃўрЃА рЃЏрЃўрЃюрЃўрЃЏрЃљрЃџрЃБрЃарЃў рЃќрЃдрЃЋрЃљрЃарЃў (KB), рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃАрЃљрЃГрЃўрЃарЃЮрЃљ рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃЊрЃљрЃАрЃљрЃгрЃДрЃћрЃЉрЃљрЃЊ. | РЮї | `80` |

## 5. Service API (`ota_api_t`)

рЃАрЃ«рЃЋрЃљ рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃА рЃерЃћрЃБрЃФрЃџрЃўрЃљрЃЌ рЃЏрЃўрЃўрЃдрЃЮрЃю рЃгрЃЋрЃЊрЃЮрЃЏрЃљ OTA рЃЏрЃћрЃюрЃћрЃ»рЃћрЃарЃўрЃА API-рЃќрЃћ `Service Locator`-рЃўрЃА рЃЏрЃћрЃерЃЋрЃћрЃЮрЃЉрЃўрЃЌ. рЃАрЃћрЃарЃЋрЃўрЃАрЃўрЃА рЃбрЃўрЃърЃў: `FMW_SERVICE_TYPE_OTA_API`.

**API рЃцрЃБрЃюрЃЦрЃфрЃўрЃћрЃЉрЃў:**

* **`esp_err_t start_update(const char *firmware_url);`**  
  рЃўрЃгрЃДрЃћрЃЉрЃА OTA рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃърЃарЃЮрЃфрЃћрЃАрЃА рЃЏрЃўрЃЌрЃўрЃЌрЃћрЃЉрЃБрЃџрЃў URL-рЃЊрЃљрЃю. рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ рЃљрЃа рЃљрЃарЃўрЃА рЃЏрЃЉрЃџрЃЮрЃЎрЃљрЃЋрЃў; рЃўрЃА рЃЦрЃЏрЃюрЃўрЃА рЃцрЃЮрЃюрЃБрЃа рЃбрЃљрЃАрЃЎрЃА рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃерЃћрЃАрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃџрЃљрЃЊ рЃЊрЃљ рЃЏрЃДрЃўрЃАрЃўрЃћрЃарЃљрЃЊ рЃљрЃЉрЃарЃБрЃюрЃћрЃЉрЃА рЃърЃљрЃАрЃБрЃ«рЃА. рЃърЃарЃЮрЃфрЃћрЃАрЃўрЃА рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃЏрЃЮрЃюрЃўрЃбрЃЮрЃарЃўрЃюрЃњрЃў рЃерЃћрЃАрЃљрЃФрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃўрЃА рЃАрЃљрЃерЃБрЃљрЃџрЃћрЃЉрЃўрЃЌ.

## 6. рЃњрЃљрЃЏрЃЮрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃБрЃџрЃў рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃў

* **`OTA_STARTED`**
  * **рЃарЃЮрЃЊрЃўрЃА рЃЦрЃЋрЃћрЃДрЃюрЃЊрЃћрЃЉрЃљ:** рЃарЃЮрЃЊрЃћрЃАрЃљрЃф рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃўрЃгрЃДрЃћрЃЉрЃљ.
  * **Payload (cJSON рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў):** `{"url":"https://..."}`

* **`OTA_PROGRESS`**
  * **рЃарЃЮрЃЊрЃўрЃА рЃЦрЃЋрЃћрЃДрЃюрЃЊрЃћрЃЉрЃљ:** рЃърЃћрЃарЃўрЃЮрЃЊрЃБрЃџрЃљрЃЊ, рЃњрЃљрЃЊрЃЏрЃЮрЃгрЃћрЃарЃўрЃА рЃърЃарЃЮрЃфрЃћрЃАрЃерЃў.
  * **Payload (cJSON рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў):** `{"progress_percent": 25}`

* **`OTA_SUCCESS`**
  * **рЃарЃЮрЃЊрЃўрЃА рЃЦрЃЋрЃћрЃДрЃюрЃЊрЃћрЃЉрЃљ:** рЃарЃЮрЃЊрЃћрЃАрЃљрЃф firmware рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃњрЃљрЃЊрЃЏрЃЮрЃўрЃгрЃћрЃарЃћрЃЉрЃљ, рЃЋрЃљрЃџрЃўрЃЊрЃљрЃфрЃўрЃљрЃА рЃњрЃљрЃўрЃЋрЃџрЃўрЃА рЃЊрЃљ рЃЏрЃќрЃљрЃЊ рЃљрЃарЃўрЃА рЃўрЃюрЃАрЃбрЃљрЃџрЃљрЃфрЃўрЃўрЃАрЃЌрЃЋрЃўрЃА (рЃњрЃљрЃЊрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ).
  * **Payload:** `NULL`

* **`OTA_FAILED`**
  * **рЃарЃЮрЃЊрЃўрЃА рЃЦрЃЋрЃћрЃДрЃюрЃЊрЃћрЃЉрЃљ:** рЃЌрЃБ рЃърЃарЃЮрЃфрЃћрЃАрЃўрЃА рЃюрЃћрЃЉрЃўрЃАрЃЏрЃўрЃћрЃа рЃћрЃбрЃљрЃърЃќрЃћ рЃЏрЃЮрЃ«рЃЊрЃљ рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ.
  * **Payload (cJSON рЃАрЃбрЃарЃўрЃЦрЃЮрЃюрЃў):** `{"error_code": -1, "error_msg": "Signature validation failed"}`

## 7. ­ЪњА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў

`cmd_router` рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃљрЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃА `ota_start` рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљрЃА, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃўрЃдрЃћрЃЉрЃА URL-рЃА рЃЊрЃљ рЃўрЃгрЃДрЃћрЃЉрЃА рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃљрЃА.

```c
// cmd_router.c-рЃерЃў рЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃБрЃџрЃў handler

esp_err_t ota_command_handler(int argc, char **argv, void *context) {
    if (argc != 2) {
        printf("Usage: ota_start <https_url>\n");
        return ESP_ERR_INVALID_ARG;
    }

    const char *url = argv[1];

    service_handle_t handle = fmw_service_get("main_ota_manager");
    if (!handle) {
        printf("OTA Manager service not available.\n");
        return ESP_FAIL;
    }

    ota_api_t *ota_api = (ota_api_t *)handle;
    
    printf("Requesting OTA update from URL: %s\n", url);
    esp_err_t ret = ota_api->start_update(url);

    if (ret == ESP_OK) {
        printf("OTA process initiated successfully.\n");
    } else {
        printf("Failed to initiate OTA process: %s\n", esp_err_to_name(ret));
    }
    
    return ret;
}
```

### 8. рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃЋрЃљрЃџрЃўрЃЊрЃљрЃфрЃўрЃљ рЃЊрЃљ Rollback

`ota_manager` рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃАрЃарЃБрЃџрЃљрЃЊ рЃўрЃДрЃћрЃюрЃћрЃЉрЃА ESP-IDF-рЃўрЃА рЃЕрЃљрЃерЃћрЃюрЃћрЃЉрЃБрЃџ Rollback рЃЏрЃћрЃЦрЃљрЃюрЃўрЃќрЃЏрЃА, рЃарЃљрЃЌрЃљ рЃБрЃќрЃарЃБрЃюрЃЋрЃћрЃџрЃДрЃЮрЃА рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃърЃарЃЮрЃфрЃћрЃАрЃўрЃА рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮрЃћрЃЉрЃљ.

* **рЃЊрЃарЃЮрЃћрЃЉрЃўрЃЌрЃў рЃњрЃљрЃерЃЋрЃћрЃЉрЃљ:** рЃљрЃ«рЃљрЃџрЃў firmware-рЃўрЃА рЃЕрЃљрЃгрЃћрЃарЃўрЃАрЃљ рЃЊрЃљ рЃњрЃљрЃЊрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ, рЃАрЃўрЃАрЃбрЃћрЃЏрЃљ рЃўрЃарЃЌрЃЋрЃћрЃЉрЃљ "рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃўрЃА рЃарЃћрЃЪрЃўрЃЏрЃерЃў".
* **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃў рЃЊрЃљрЃЉрЃарЃБрЃюрЃћрЃЉрЃљ:** рЃЌрЃБ рЃљрЃ«рЃљрЃџрЃў firmware рЃЋрЃћрЃа рЃЊрЃљрЃљрЃЊрЃљрЃАрЃбрЃБрЃарЃћрЃЉрЃА рЃЌрЃљрЃЋрЃўрЃА рЃњрЃљрЃЏрЃљрЃарЃЌрЃБрЃџ рЃЏрЃБрЃерЃљрЃЮрЃЉрЃљрЃА (рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃљрЃЊ, рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџрЃў рЃерЃћрЃфрЃЊрЃЮрЃЏрЃўрЃА рЃљрЃю boot-loop-рЃўрЃА рЃњрЃљрЃЏрЃЮ), bootloader-рЃў рЃерЃћрЃЏрЃЊрЃћрЃњ рЃњрЃљрЃЊрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃљрЃќрЃћ рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃЊрЃљрЃљрЃЉрЃарЃБрЃюрЃћрЃЉрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃљрЃА рЃгрЃўрЃюрЃљ, рЃАрЃбрЃљрЃЉрЃўрЃџрЃБрЃа рЃЋрЃћрЃарЃАрЃўрЃљрЃќрЃћ.
* **рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃЊрЃљрЃЊрЃљрЃАрЃбрЃБрЃарЃћрЃЉрЃљ:** `ota_manager` (рЃљрЃю рЃАрЃ«рЃЋрЃљ рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃарЃў рЃЏрЃЮрЃЊрЃБрЃџрЃў) рЃърЃљрЃАрЃБрЃ«рЃўрЃАрЃЏрЃњрЃћрЃЉрЃћрЃџрЃўрЃљ, рЃњрЃљрЃЏрЃЮрЃўрЃФрЃљрЃ«рЃЮрЃА `esp_ota_mark_app_valid_cancel_rollback()` рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ рЃЏрЃљрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ, рЃарЃљрЃф рЃЊрЃљрЃарЃгрЃЏрЃБрЃюрЃЊрЃћрЃЉрЃљ, рЃарЃЮрЃЏ рЃАрЃўрЃАрЃбрЃћрЃЏрЃљ рЃАрЃарЃБрЃџрЃљрЃЊ рЃцрЃБрЃюрЃЦрЃфрЃўрЃЮрЃюрЃљрЃџрЃБрЃарЃўрЃљ (рЃЏрЃљрЃњ., WiFi-рЃАрЃЌрЃљрЃю рЃЎрЃљрЃЋрЃерЃўрЃарЃў рЃЊрЃљрЃЏрЃДрЃљрЃарЃЊрЃљ, MQTT рЃАрЃћрЃарЃЋрЃћрЃарЃЌрЃљрЃю рЃЊрЃљрЃЎрЃљрЃЋрЃерЃўрЃарЃћрЃЉрЃљ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃўрЃљ). рЃћрЃА, рЃарЃЮрЃњрЃЮрЃарЃф рЃгрЃћрЃАрЃў, рЃ«рЃЊрЃћрЃЉрЃљ `SYSTEM_START` рЃўрЃЋрЃћрЃюрЃЌрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ, рЃњрЃљрЃарЃЎрЃЋрЃћрЃБрЃџрЃў рЃърЃўрЃарЃЮрЃЉрЃћрЃЉрЃўрЃА рЃерЃћрЃАрЃарЃБрЃџрЃћрЃЉрЃўрЃАрЃљрЃА.
