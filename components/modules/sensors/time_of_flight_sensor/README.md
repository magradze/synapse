# 🔬 მოდული: `time_of_flight_sensor`

**🗂️ კატეგორია:** `sensors`  
**✒️ ავტორი:** Synapse Framework Team  
**🔖 ვერსია:** 1.1.0

## 1. 📜 მიმოხილვა

`time_of_flight_sensor` არის Synapse Framework-ის დრაივერის მოდული, რომელიც შექმნილია **VL6180X** ტიპის I2C Time-of-Flight (TOF) მანძილის სენსორებთან სამუშაოდ. ეს სენსორები იყენებენ ინფრაწითელ სინათლეს, რათა მაღალი სიზუსტით გაზომონ მანძილი ობიექტამდე.

მოდული არის სუფთა **"Event Producer"**. ის პერიოდულად კითხულობს სენსორის მონაცემებს და შედეგს (მანძილს მილიმეტრებში) აქვეყნებს `Event Bus`-ზე, რაც საშუალებას აძლევს სხვა მოდულებს (როგორიცაა `sensor_aggregator`) გამოიყენონ ეს ინფორმაცია.

## 2. 🏛️ არქიტექტურული პრინციპები

- **სერვისის მომხმარებელი (Service Consumer):** მოდული არის ორი ფუნდამენტური სერვისის აქტიური მომხმარებელი:
    1. **`i2c_bus` სერვისი:** გამოიყენება სენსორთან ფიზიკური კომუნიკაციისთვის I2C პროტოკოლით.
    2. **`system_timer` სერვისი:** გამოიყენება პერიოდული გაზომვების დასაგეგმად, რაც გამორიცხავს `vTaskDelay`-ზე დაფუძნებული ცალკეული ტასკის საჭიროებას და ზოგავს სისტემურ რესურსებს.
- **ივენთების მომწოდებელი (Event Producer):** მოდულის მთავარი ამოცანაა, `SENSOR_DATA_DISTANCE_MM` ივენთის გენერაცია. ეს უზრუნველყოფს სრულ იზოლაციას (decoupling) იმ მოდულებისგან, რომლებიც ამ მონაცემს მოიხმარენ.
- **სტანდარტული ინიციალიზაციის დონე (`init_level: 60`):** როგორც სენსორების უმეტესობა, ის ინიციალიზდება სისტემის გაშვების საშუალო ეტაპზე. ეს გარანტიას იძლევა, რომ მისთვის საჭირო `i2c_bus` (init_level: 10) და `system_timer` (init_level: 50-59) სერვისები უკვე ხელმისაწვდომია.

## 3. ⚙️ კონფიგურაცია (`config.json`)

მოდულის კონფიგურაცია ხდება მისი `config.json` ფაილის საშუალებით.

**კონფიგურაციის მაგალითი:**

```json
[
  {
    "type": "time_of_flight_sensor",
    "enabled": true,
    "config": {
        "instance_name": "main_tof_sensor",
        "i2c_bus_name": "main_i2c_bus",
        "update_interval_sec": 5
    }
  }
]
```

**კონფიგურაციის პარამეტრები:**

| პარამეტრი | ტიპი | აღწერა | სავალდებულო | Default (Kconfig) |
| :--- | :--- | :--- | :---: | :--- |
| `instance_name` | სტრიქონი | მოდულის უნიკალური სახელი სისტემაში. | ✅ | `main_tof_sensor` |
| `i2c_bus_name` | სტრიქონი | იმ `i2c_bus` სერვისის სახელი, რომელსაც სენსორი უკავშირდება. | ✅ | `main_i2c_bus` |
| `update_interval_sec` | რიცხვი | გაზომვებს შორის ინტერვალი წამებში. | ✅ | `10` |

## 4. 📢 ივენთები (Events)

### გამოქვეყნებული ივენთები

| ივენთის სახელი | მონაცემები (Payload) | აღწერა |
| :--- | :--- | :--- |
| `SENSOR_DATA_DISTANCE_MM` | `char*` (JSON) | ქვეყნდება ყოველი წარმატებული გაზომვის შემდეგ. Payload არის JSON სტრიქონი, რომელიც შეიცავს გაზომილ მანძილს მილიმეტრებში. |

**Payload-ის მაგალითი:**

```json
{"value": 123}
```

## 5. 💡 გამოყენების მაგალითი (`sensor_aggregator`-თან ინტეგრაცია)

ამ მოდულის მთავარი დანიშნულებაა, მიაწოდოს მონაცემები `sensor_aggregator`-ს. ამისათვის, `sensor_aggregator/config.json` ფაილში უნდა დაამატოთ შესაბამისი ჩანაწერი:

```json
// In sensor_aggregator/config.json, inside "sensors_to_aggregate" array:
{
    "event_name": "SENSOR_DATA_DISTANCE_MM",
    "json_key": "distance_mm",
    "aggregation_mode": "last" // or "avg", "min", "max"
}
```

ამ კონფიგურაციით, `sensor_aggregator` დაიწყებს `SENSOR_DATA_DISTANCE_MM` ივენთების მოსმენას და თავის პერიოდულ რეპორტში დაამატებს `distance_mm` ველს, რომელიც შეიცავს TOF სენსორის მიერ გაზომილ ბოლო მანძილს.

## 6. ❗ მნიშვნელოვანი შენიშვნები

- **ფიზიკური შეერთება:** სენსორის გამართული მუშაობისთვის, `SHUT` (Shutdown) პინი უნდა იყოს მიერთებული 3.3V-ზე. `INT` (Interrupt) პინი ამ იმპლემენტაციაში არ გამოიყენება და შეიძლება თავისუფალი დარჩეს.
- **სენსორის სიზუსტე:** VL6180X სენსორის ეფექტური დიაპაზონი, როგორც წესი, არის 5-დან 100-200 მილიმეტრამდე, ობიექტის ზედაპირისა და გარემო პირობების მიხედვით. `255mm` მნიშვნელობა ხშირად მიუთითებს დიაპაზონს გარეთ ყოფნაზე ან გაზომვის შეცდომაზე.
- **დამოკიდებულება `CMakeLists.txt`-ში:** ამ მოდულს არ სჭირდება სხვა მოდულების პირდაპირი დამოკიდებულება, რადგან ის ყველა საჭირო სერვისს იღებს `interfaces`-ის მეშვეობით.
